<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM - Property Owner Management</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        /* Top Navigation Bar */
        .top-bar {
            background: #2B5AA8;
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .search-box {
            position: relative;
            flex: 0 0 300px;
        }

        .search-box input {
            width: 100%;
            padding: 8px 35px 8px 12px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-box button {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: #2B5AA8;
            cursor: pointer;
            font-size: 18px;
        }

        .date-picker {
            padding: 8px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: opacity 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-filter {
            background: #5B9BD5;
            color: white;
        }

        .btn-status {
            background: #70AD47;
            color: white;
        }

        .btn-call {
            background: #FF8C42;
            color: white;
        }

        .btn-add-owner {
            background: #70AD47;
            color: white;
            margin-left: auto;
        }

        .btn-add-property {
            background: #FF8C42;
            color: white;
        }

        /* Main Layout */
        .container {
            display: flex;
            height: calc(100vh - 60px);
        }

        /* Left Panel - Owners List */
        .left-panel {
            width: 320px;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            font-weight: 600;
            font-size: 15px;
            color: #2B5AA8;
            position: sticky;
            top: 0;
            z-index: 10;
            background: white;
        }

        .owners-section { /* New wrapper */
            height: 75%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .owners-list {
            flex: 1; /* Takes up remaining space in owners-section */
            overflow-y: auto;
        }

        .owner-item {
            padding: 8px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }

        .owner-item:hover {
            background: #f8f9fa;
        }

        .owner-item.active {
            background: #E8F0FE;
            border-left: 3px solid #2B5AA8;
        }

        .owner-status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .owner-info {
            flex: 1;
            min-width: 0;
        }

        .owner-name {
            font-weight: 500;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .owner-properties {
            font-size: 12px;
            color: #666;
        }

        .follow-up-section {
            height: 25%; /* Remaining height */
            border-top: 2px solid #ddd;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .follow-up-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        /* Center Panel - Property Details */
        .center-panel {
            flex: 1;
            background: white;
            overflow-y: auto;
            padding: 20px;
        }

        .property-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .property-title {
            font-size: 24px;
            font-weight: 600;
            color: #2B5AA8;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .property-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .property-counter {
            color: #666;
            font-size: 14px;
        }

        .nav-btn {
            background: #2B5AA8;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
        }

        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-star {
            background: #FFC107;
            color: white;
        }

        .btn-delete {
            background: #DC3545;
            color: white;
        }

        .link-btn.linkedin {
            background: #0077b5;
            color: white;
        }

        .link-btn.website {
            background: #f0f0f0;
            color: #333;
        }

        .property-images {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .image-container {
            aspect-ratio: 16/9;
            background: #f0f0f0;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
            position: relative;
        }

        .image-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
            background: rgba(0,0,0,0.5);
            padding: 4px;
            border-radius: 4px;
        }
        .image-actions button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }


        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .section-title {
            font-size: 15px;
            font-weight: 600;
            color: #2B5AA8;
            margin-top: 15px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #E8F0FE;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: -5px; /* Negative margin to tighten space */
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
            text-align: center;
            font-weight: 500;
        }

        .form-input {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #2B5AA8;
            box-shadow: 0 0 0 2px rgba(43, 90, 168, 0.1);
        }

        .form-input.highlight-green {
            background: #E8F5E9;
        }

        .form-input.highlight-yellow {
            background: #FFF9E6;
        }

        .link-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .link-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .link-btn.costar {
            background: #2B5AA8; /* Blue */
            color: white;
        }
        .link-btn.tps {
            background: #6c757d; /* Gray */
            color: white;
        }
        .link-btn.llc {
            background: #28a745; /* Green */
            color: white;
        }

        .link-btn.no-link {
            background: #f0f0f0;
            color: #999;
            cursor: not-allowed;
        }

        .link-btn-group {
            flex: 1;
            display: flex;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        .link-action-btn {
            background: #eee;
            border: none;
            border-left: 1px solid #ddd;
            padding: 0 10px;
            cursor: pointer;
        }
        .link-action-btn:hover {
            background: #ddd;
        }

        .phone-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .phone-table th {
            background: #f8f9fa;
            padding: 8px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
        }

        .phone-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .phone-table input[type="text"] {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 13px;
        }

        .phone-table input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .phone-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
        }

        .add-phone-btn {
            margin-top: 10px;
            background: #70AD47;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .cell-only-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            justify-content: flex-end;
        }

        /* Right Panel - Map & Logs */
        .right-panel {
            width: 400px;
            background: white;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        #map {
            height: 300px;
            border-bottom: 1px solid #ddd;
        }

        .log-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .log-header {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-title {
            font-weight: 600;
            color: #2B5AA8;
        }

        .log-property-name {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .btn-log-call {
            background: #2B5AA8;
            color: white;
        }

        .log-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .log-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #2B5AA8;
        }

        .log-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .log-type {
            font-weight: 600;
            color: #2B5AA8;
            margin-bottom: 6px;
        }

        .log-notes {
            font-size: 13px;
            color: #333;
            line-height: 1.4;
        }

        .no-logs {
            text-align: center;
            color: #999;
            padding: 40px 20px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .owner-search-container {
            position: relative;
        }
        .owner-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1002;
            display: none;
        }
        .owner-search-item {
            padding: 10px;
            cursor: pointer;
            font-size: 14px;
        }
        .owner-search-item:hover {
            background: #E8F0FE;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #2B5AA8;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        .btn-submit {
            background: #2B5AA8;
            color: white;
        }

        /* Filter Panel */
        .filter-panel {
            background: white;
            padding: 20px;
            margin: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .status-tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .status-tag {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 15px;
            cursor: pointer;
            background: #f8f9fa;
            font-size: 12px;
            transition: all 0.2s;
        }
        .status-tag.active {
            background: #2B5AA8;
            color: white;
            border-color: #2B5AA8;
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Responsive adjustments */
        @media (max-width: 1400px) {
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .chart-container {
            max-width: 800px;
            margin: 20px auto;
        }

        select.form-input {
            cursor: pointer;
        }

        .marker-pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            background: #c30b0b;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -15px 0 0 -15px;
        }
        .marker-pin::after {
            content: '';
            width: 14px;
            height: 14px;
            margin: 8px 0 0 8px;
            background: #fff;
            position: absolute;
            border-radius: 50%;
        }

        select.status-dropdown option {
            padding: 5px;
        }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <div class="top-bar">
        <div class="search-box">
            <input type="text" id="searchInput" oninput="performSearch()" placeholder="Search Owner or Address...">
        </div>
        <input type="date" id="datePicker" class="date-picker">
        <button class="btn btn-filter" onclick="toggleFilters()">‚ñº Filter Properties</button>
        <button class="btn btn-status" onclick="showStatusBreakdown()">üìä Status Breakdown</button>
        <button class="btn btn-call" onclick="showCallTracker()">üìû Call Tracker</button>
        <button class="btn btn-add-owner" onclick="showAddOwnerModal()">+ Add Owner</button>
        <button class="btn btn-add-property" onclick="showAddPropertyModal()">+ Add Property</button>
    </div>

    <!-- Filter Panel (Initially Hidden) -->
    <div id="filterPanel" style="display: none;">
        <div class="filter-panel">
            <h3>Filter Properties</h3>
            <div class="filter-grid">
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <select id="filterLocation" class="form-input" onchange="applyFilters()">
                        <option value="">All Locations</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">City</label>
                    <select id="filterCity" class="form-input" onchange="applyFilters()">
                        <option value="">All Cities</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Submarket</label>
                    <select id="filterSubmarket" class="form-input" onchange="applyFilters()">
                        <option value="">All Submarkets</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Zip</label>
                    <select id="filterZip" class="form-input" onchange="applyFilters()">
                        <option value="">All Zips</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Year Built (Min)</label>
                    <input type="number" id="filterYearMin" class="form-input" placeholder="Min Year" oninput="applyFilters()">
                </div>
                <div class="form-group">
                    <label class="form-label">Year Built (Max)</label>
                    <input type="number" id="filterYearMax" class="form-input" placeholder="Max Year" oninput="applyFilters()">
                </div>
                <div class="form-group">
                    <label class="form-label">Units (Min)</label>
                    <input type="number" id="filterUnitsMin" class="form-input" placeholder="Min Units" oninput="applyFilters()">
                </div>
                <div class="form-group">
                    <label class="form-label">Units (Max)</label>
                    <input type="number" id="filterUnitsMax" class="form-input" placeholder="Max Units" oninput="applyFilters()">
                </div>
                <div class="form-group">
                    <label class="form-label">Owner Status</label>
                    <select id="filterStatus" class="form-input" onchange="applyFilters()">
                        <option value="">All Statuses</option>
                    </select>
                </div>
                 <div class="form-group" style="grid-column: span 3; display: none;">
                    <label class="form-label">Status Tags</label>
                    <div id="filterStatusTags" class="status-tags-container"></div>
                </div>
            </div>
            <div style="margin-top: 15px; text-align: right;">
                <button class="btn btn-cancel" onclick="clearFilters()">Clear Filters</button>
            </div>
        </div>
    </div>

    <!-- Edit Communication Log Modal -->
    <div id="editLogModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Communication Log</h2>
                <button class="modal-close" onclick="closeModal('editLogModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editLogId">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">Type *</label>
                    <select id="editLogType" class="form-input">
                        <option value="Call">Call</option>
                        <option value="Text">Text</option>
                        <option value="Email">Email</option>
                        <option value="Letter">Letter</option>
                        <option value="Meeting">Meeting</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">Notes</label>
                    <textarea id="editLogNotes" class="form-input" rows="4" style="resize: vertical; text-align: left;" placeholder="Enter notes..."></textarea>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">Date</label>
                    <input type="date" id="editLogDate" class="form-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-delete" onclick="deleteLog()" style="margin-right: auto;">Delete Log</button>
                <button class="btn btn-cancel" onclick="closeModal('editLogModal')">Cancel</button>
                <button class="btn btn-submit" onclick="updateLog()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Left Panel: Owners List & Follow-ups -->
        <div class="left-panel">
            <div class="owners-section">
                <div class="panel-header">
                    Owners (<span id="ownerCount">0</span>)
                </div>
                <div class="owners-list" id="ownersList">
                    <div class="loading">Loading owners...</div>
                </div>
            </div>
            <div class="follow-up-section">
                <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Follow-Up Tasks (<span id="followUpCount">0</span>)</span>
                    <select id="followUpFilter" onchange="loadFollowUpTasks()" style="font-size: 12px; padding: 2px;">
                        <option value="today">Today's Tasks</option>
                        <option value="overdue">Overdue Tasks</option>
                        <option value="all">All Tasks</option>
                    </select>
                </div>
                <div class="follow-up-list" id="followUpList">
                    <div class="loading">Loading tasks...</div>
                </div>
            </div>
        </div>

        <!-- Center Panel: Property Details -->
        <div class="center-panel" id="centerPanel">
            <div style="text-align: center; padding: 100px 20px; color: #999;">
                <h2>Select an owner to view properties</h2>
            </div>
        </div>

        <!-- Right Panel: Map & Communication Log -->
        <div class="right-panel">
            <div id="map"></div>
            <div class="log-section">
                <div class="log-header">
                    <div>
                        <div class="log-title">Log</div>
                        <div class="log-property-name" id="logPropertyName">Select a property</div>
                    </div>
                    <button class="btn-log-call" onclick="showAddLogModal()">+ Add Log</button>
                </div>
                <div class="log-list" id="logList">
                    <div class="no-logs">No communication history</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Owner Modal -->
    <div id="addOwnerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Owner</h2>
                <button class="modal-close" onclick="closeModal('addOwnerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">Owner Name *</label>
                    <input type="text" id="newOwnerName" class="form-input" style="text-align: left;" placeholder="Enter owner name">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">Owner Email</label>
                    <input type="email" id="newOwnerEmail" class="form-input" style="text-align: left;" placeholder="Enter email">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">Owner Address</label>
                    <input type="text" id="newOwnerAddress" class="form-input" style="text-align: left;" placeholder="Enter address">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">Status</label>
                    <select id="newOwnerStatus" class="form-input">
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeModal('addOwnerModal')">Cancel</button>
                <button class="btn btn-submit" onclick="addNewOwner()">Add Owner</button>
            </div>
        </div>
    </div>

    <!-- Add Property Modal -->
    <div id="addPropertyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Property</h2>
                <button class="modal-close" onclick="closeModal('addPropertyModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">Search for Owner *</label>
                    <div class="owner-search-container">
                        <input type="text" id="newPropertyOwnerSearch" class="form-input" style="text-align: left;" placeholder="Type to search..." oninput="filterOwnerSearch('newPropertyOwner')">
                        <input type="hidden" id="newPropertyOwner">
                        <div id="newPropertyOwnerSearchResults" class="owner-search-results"></div>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">Property Address *</label>
                    <input type="text" id="newPropertyAddress" class="form-input" style="text-align: left;" placeholder="Enter property address">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">Property Name</label>
                    <input type="text" id="newPropertyName" class="form-input" style="text-align: left;" placeholder="Enter property name">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">City</label>
                    <input type="text" id="newPropertyCity" class="form-input" style="text-align: left;" placeholder="Enter city">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">State</label>
                    <input type="text" id="newPropertyState" class="form-input" style="text-align: left;" placeholder="Enter state">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">ZIP</label>
                    <input type="text" id="newPropertyZip" class="form-input" style="text-align: left;" placeholder="Enter ZIP">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeModal('addPropertyModal')">Cancel</button>
                <button class="btn btn-submit" onclick="addNewProperty()">Add Property</button>
            </div>
        </div>
    </div>

    <!-- Add Communication Log Modal -->
    <div id="addLogModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Communication Log</h2>
                <button class="modal-close" onclick="closeModal('addLogModal')">&times;</button>
            </div>
            <div class="modal-body">
                 <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">Type *</label>
                    <select id="newLogType" class="form-input">
                        <option value="Call">Call</option>
                        <option value="Text">Text</option>
                        <option value="Email">Email</option>
                        <option value="Letter">Letter</option>
                        <option value="Meeting">Meeting</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">Notes</label>
                    <textarea id="newLogNotes" class="form-input" rows="4" style="resize: vertical; text-align: left;" placeholder="Enter notes..."></textarea>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">Next Follow-Up Date (Optional)</label>
                    <input type="date" id="newLogFollowUp" class="form-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeModal('addLogModal')">Cancel</button>
                <button class="btn btn-submit" onclick="addNewLog()">Save Log</button>
            </div>
        </div>
    </div>

    <!-- Transfer Property Modal -->
    <div id="transferPropertyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Transfer Property</h2>
                <button class="modal-close" onclick="closeModal('transferPropertyModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Transfer this property to a new owner.</p>
                <div class="form-group" style="margin-top: 15px;">
                    <label class="form-label" style="text-align: left;">Search for New Owner</label>
                    <div class="owner-search-container">
                        <input type="text" id="transferOwnerSearch" class="form-input" style="text-align: left;" placeholder="Type to search..." oninput="filterOwnerSearch('transferOwner')">
                        <input type="hidden" id="transferOwner">
                        <div id="transferOwnerSearchResults" class="owner-search-results"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeModal('transferPropertyModal')">Cancel</button>
                <button class="btn btn-submit" onclick="transferProperty()">Transfer</button>
            </div>
        </div>
    </div>

    <!-- Status Breakdown Modal -->
    <div id="statusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Owner Status Breakdown</h2>
                <button class="modal-close" onclick="closeModal('statusModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
                <div id="statusStats" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- Call Tracker Modal -->
    <div id="callTrackerModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Call Tracker</h2>
                <button class="modal-close" onclick="closeModal('callTrackerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="chart-container">
                    <canvas id="callChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Generic Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="editModalTitle">Edit Value</h2>
                <button class="modal-close" onclick="closeModal('editModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;" id="editModalLabel">New Value</label>
                    <input type="text" id="editModalInput" class="form-input" style="text-align: left;">
                    <input type="hidden" id="editModalField">
                    <input type="hidden" id="editModalEntityType">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeModal('editModal')">Cancel</button>
                <button class="btn btn-submit" onclick="saveFromEditModal()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://xxqesoposwpvljxdfkim.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4cWVzb3Bvc3dwdmxqeGRma2ltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNTU1NDcsImV4cCI6MjA3NDkzMTU0N30.zCJvWNnoKxTlOxJgos8dqfoVYqlXvsfk7_GbjGyt2jo';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global State
        let allOwners = [];
        let allProperties = [];
        let allLogs = [];
        let currentOwner = null;
        let currentProperty = null;
        let currentPropertyIndex = 0;
        let ownerProperties = [];
        let map = null;
        let marker = null;
        let propertyMarkers = [];

        // Performance-related state
        let searchDebounceTimer;
        let ownerSearchDebounceTimer;

        const STATUS_OPTIONS = {
            'Never Spoken': '#3498db', // blue
            'IPA': '#34495e',           // black
            'Spoken To': '#2ecc71',     // green
            'Listed': '#e67e22',        // orange
            'WR / ND': '#f1c40f',       // yellow
            'Condo/Religious': '#e91e63', // pink
            'Broker': '#9b59b6',        // purple
            'TCG': '#34495e',           // black
        };

        const STATUS_TAGS = [
            'Buyer', 'Seller', 'Meeting', 'Proposal', '1031', 'Talker',
            '6 Months', 'Market Updates', 'Developer', 'IPA', 'Email',
            'Never Call', 'Rex St', 'Ftn Blue', 'Tabor/Water'
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            initMap();
            await loadAllData();
            setTodayDate();
            populateStatusDropdowns();
            renderFilterTags();
        });

        // Initialize Map
        function initMap() {
            map = L.map('map').setView([45.5231, -122.6765], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        // Set today's date in date picker
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('datePicker').value = today;
        }

        // Load All Data from Supabase
        async function loadAllData() {
            try {
                const { data: owners, error: ownersError } = await supabase.from('owners').select('*');
                if (ownersError) throw ownersError;
                allOwners = owners;

                const { data: properties, error: propertiesError } = await supabase.from('properties').select('*');
                if (propertiesError) throw propertiesError;
                allProperties = properties;

                const { data: logs, error: logsError } = await supabase.from('communication_logs').select('*');
                if (logsError) throw logsError;
                allLogs = logs;

                console.log(`Loaded ${allOwners.length} owners, ${allProperties.length} properties, and ${allLogs.length} logs`);

                renderOwnersList();
                populateFilterDropdowns();
                loadFollowUpTasks();
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading data from Supabase. Please refresh the page.');
            }
        }

        // Render/Append Owners List
        function renderOwnersList(ownersToRender = allOwners) {
            const ownersList = document.getElementById('ownersList');
            const ownerCount = document.getElementById('ownerCount');

            ownersList.innerHTML = ''; // Clear the list before rendering
            ownerCount.textContent = ownersToRender.length;

            if (ownersToRender.length === 0) {
                ownersList.innerHTML = '<div class="loading">No owners found</div>';
                return;
            }

            appendOwnersToList(ownersToRender);
        }

        function appendOwnersToList(owners) {
            const ownersList = document.getElementById('ownersList');
            const ownerCount = document.getElementById('ownerCount');

            // Remove initial loading message if it exists
            const loadingDiv = ownersList.querySelector('.loading');
            if (loadingDiv) {
                loadingDiv.remove();
            }

            ownerCount.textContent = owners.length;

            const html = owners.map(owner => {
                const propertyCount = allProperties.filter(p => p.owner_id === owner.id).length;
                const statusColor = STATUS_OPTIONS[owner.marker_pin] || '#6c757d';

                return `
                    <div class="owner-item" onclick="selectOwner('${owner.id}')">
                        <div class="owner-status-dot" style="background-color: ${statusColor}"></div>
                        <div class="owner-info">
                            <div class="owner-name">${owner.owner_name || 'Unnamed Owner'}</div>
                            <div class="owner-properties">${propertyCount} ${propertyCount === 1 ? 'Property' : 'Properties'}</div>
                        </div>
                    </div>
                `;
            }).join('');

            ownersList.insertAdjacentHTML('beforeend', html);
        }

        // Select Owner
        async function selectOwner(ownerId) {
            currentOwner = allOwners.find(o => o.id === ownerId);
            if (!currentOwner) return;

            // Attach logs to the owner object
            currentOwner.logs = allLogs.filter(log => log.owner_id === currentOwner.id);

            // Highlight selected owner
            document.querySelectorAll('.owner-item').forEach(item => item.classList.remove('active'));
            const activeItem = Array.from(document.querySelectorAll('.owner-item')).find(el => el.getAttribute('onclick') === `selectOwner('${ownerId}')`);
            if (activeItem) activeItem.classList.add('active');

            // Get owner's properties from the global array
            ownerProperties = allProperties.filter(p => p.owner_id === ownerId);
            currentPropertyIndex = 0;

            if (ownerProperties.length > 0) {
                currentProperty = ownerProperties[0];
            } else {
                currentProperty = null;
            }
            await renderCenterPanel();
            renderCommunicationLogs();
        }

        // Load and Render Follow-Up Tasks
        function loadFollowUpTasks() {
            const followUpList = document.getElementById('followUpList');
            const followUpCount = document.getElementById('followUpCount');
            const filter = document.getElementById('followUpFilter').value;
            const today = document.getElementById('datePicker').value;

            followUpList.innerHTML = ''; // Clear previous list

            let tasks = [];
            const ownersWithFollowUp = allOwners.filter(o => o.next_follow_up);

            if (filter === 'today') {
                tasks = ownersWithFollowUp.filter(o => o.next_follow_up === today);
            } else if (filter === 'overdue') {
                tasks = ownersWithFollowUp.filter(o => o.next_follow_up < today);
            } else { // 'all'
                tasks = ownersWithFollowUp;
            }

            tasks.sort((a, b) => new Date(a.next_follow_up) - new Date(b.next_follow_up));

            followUpCount.textContent = tasks.length;
            if (tasks.length === 0) {
                followUpList.innerHTML = '<div style="padding: 15px; color: #666; font-size: 14px;">No tasks found.</div>';
                return;
            }

            followUpList.innerHTML = tasks.map(task => `
                <div class="owner-item" onclick="selectOwner('${task.id}')" style="padding: 10px;">
                    <div class="owner-info">
                        <div class="owner-name">${task.owner_name}</div>
                        <div class="owner-properties" style="color: ${task.next_follow_up < today ? '#c0392b' : '#333'};">
                            Due: ${formatDate(task.next_follow_up)}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function highlightField(value) {
            return value ? 'highlight-green' : 'highlight-yellow';
        }

        function updateMapForOwner() {
            // 1. Clear existing markers
            propertyMarkers.forEach(marker => marker.remove());
            propertyMarkers = [];

            if (!currentOwner || ownerProperties.length === 0) {
                map.setView([45.5231, -122.6765], 11); // Reset view if no properties
                return;
            }

            const bounds = [];

            // 2. Add a marker for each property
            ownerProperties.forEach((prop, index) => {
                if (prop.latt && prop.long) {
                    const lat = parseFloat(prop.latt);
                    const lng = parseFloat(prop.long);
                    if (!isNaN(lat) && !isNaN(lng)) {
                        const isSelected = index === currentPropertyIndex;
                        const marker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'custom-div-icon',
                                html: `<div style='background-color:${isSelected ? "#e67e22" : "#2B5AA8"};' class='marker-pin'></div>`,
                                iconSize: [30, 42],
                                iconAnchor: [15, 42]
                            })
                        }).addTo(map);

                        marker.bindPopup(`<b>${prop.address || 'Property'}</b>`);
                        propertyMarkers.push(marker);
                        bounds.push([lat, lng]);
                    }
                }
            });

            // 3. Zoom to fit all markers, or to the selected one
            if (bounds.length > 0) {
                 if (currentProperty && currentProperty.latt && currentProperty.long) {
                    map.setView([currentProperty.latt, currentProperty.long], 15);
                } else {
                    map.fitBounds(bounds);
                }
            }
        }

        function populateOwnerStatusDropdown() {
            const select = document.getElementById('ownerStatusSelect');
            if (!select) return;

            select.innerHTML = '';
            for (const status in STATUS_OPTIONS) {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                option.style.color = STATUS_OPTIONS[status];
                if (status === currentOwner.marker_pin) {
                    option.selected = true;
                    select.style.color = STATUS_OPTIONS[status];
                }
                select.appendChild(option);
            }
            select.onchange = (e) => {
                select.style.color = STATUS_OPTIONS[e.target.value];
                updateOwner('marker_pin', e.target.value);
            };
        }

        // Render Center Panel
        async function renderCenterPanel() {
            if (!currentOwner) {
                document.getElementById('centerPanel').innerHTML = `
                    <div style="text-align: center; padding: 100px 20px; color: #999;">
                        <h2>Select an owner to view details</h2>
                    </div>`;
                return;
            }

            const centerPanel = document.getElementById('centerPanel');

            const ownerHeaderHtml = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h1 style="font-size: 28px; color: #333;">
                        ${currentOwner.owner_name}
                        <button class="phone-action-btn" onclick="showEditModal('owner', 'owner_name', 'Edit Owner Name', 'Name', currentOwner.owner_name)">‚úèÔ∏è</button>
                         <button class="phone-action-btn" style="color: #c0392b;" onclick="deleteOwner(this)">üóëÔ∏è</button>
                    </h1>
                </div>
            `;

            const propertyHtml = currentProperty ? renderPropertyDetails() : `
                <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #666;">This owner has no properties.</h3>
                    <button class="btn btn-add-property" style="margin-top: 15px;" onclick="showAddPropertyModal()">+ Add Property for this Owner</button>
                </div>`;

            const ownerInfoHtml = `
                <div class="section-title" style="margin-top: 20px;">Owner Information</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Owner Status</label>
                        <select id="ownerStatusSelect" class="form-input status-dropdown"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Spoken</label>
                        <input type="date" class="form-input" value="${currentOwner.last_spoken || ''}" onchange="updateOwner('last_spoken', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Next Follow-Up</label>
                        <input type="date" class="form-input ${highlightField(currentOwner.next_follow_up)}" value="${currentOwner.next_follow_up || ''}" onchange="updateOwner('next_follow_up', this.value)">
                    </div>
                     <div class="form-group full-width">
                        <label class="form-label">Owner Address</label>
                        <input type="text" class="form-input ${highlightField(currentOwner.owner_address)}" value="${currentOwner.owner_address || ''}" onchange="updateOwner('owner_address', this.value)">
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Owner Email</label>
                        <input type="email" class="form-input ${highlightField(currentOwner.owner_email)}" value="${currentOwner.owner_email || ''}" onchange="updateOwner('owner_email', this.value)">
                    </div>
                </div>

                <div class="link-buttons" style="margin-top: 15px; margin-bottom: 15px; justify-content: center; gap: 20px;">
                    <div class="link-btn-group" style="flex-grow: 0; flex-basis: 200px;">
                        <a href="${currentOwner.linkedin || 'javascript:void(0)'}" target="_blank" class="link-btn ${currentOwner.linkedin ? 'linkedin' : 'no-link'}">LinkedIn</a>
                        <button class="link-action-btn" onclick="showEditModal('owner', 'linkedin', 'Edit LinkedIn URL', 'URL', currentOwner.linkedin || '')">‚ûï</button>
                        ${currentOwner.linkedin ? `<button class="link-action-btn" onclick="updateOwner('linkedin', null)">‚ùå</button>` : ''}
                    </div>
                    <div class="link-btn-group" style="flex-grow: 0; flex-basis: 200px;">
                        <a href="${currentOwner.website || 'javascript:void(0)'}" target="_blank" class="link-btn ${currentOwner.website ? 'website' : 'no-link'}">Website</a>
                        <button class="link-action-btn" onclick="showEditModal('owner', 'website', 'Edit Website URL', 'URL', currentOwner.website || '')">‚ûï</button>
                        ${currentOwner.website ? `<button class="link-action-btn" onclick="updateOwner('website', null)">‚ùå</button>` : ''}
                    </div>
                </div>

                <div class="form-grid" style="grid-template-columns: repeat(4, 1fr); gap: 15px;">
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="form-label">Objection</label>
                        <input type="text" class="form-input ${highlightField(currentOwner.objection)}" value="${currentOwner.objection || ''}" onchange="updateOwner('objection', this.value)">
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="form-label">Opportunity</label>
                        <input type="text" class="form-input ${highlightField(currentOwner.opportunity)}" value="${currentOwner.opportunity || ''}" onchange="updateOwner('opportunity', this.value)">
                    </div>
                     <div class="form-group">
                        <label class="form-label">Birth Year</label>
                        <input type="number" class="form-input ${highlightField(currentOwner.birth_year)}" value="${currentOwner.birth_year || ''}" onchange="updateOwner('birth_year', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Birth Month</label>
                        <select class="form-input ${highlightField(currentOwner.birth_month)}" onchange="updateOwner('birth_month', this.value)">
                            <option value="" ${!currentOwner.birth_month ? 'selected' : ''}>Select Month</option>
                            ${[
                                'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                                'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
                            ].map((month, i) => `<option value="${i + 1}" ${currentOwner.birth_month == (i + 1) ? 'selected' : ''}>${month}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Age</label>
                        <input type="number" class="form-input ${highlightField(currentOwner.age)}" value="${currentOwner.age || ''}" onchange="updateOwner('age', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hobbies / Interests</label>
                        <input type="text" class="form-input ${highlightField(currentOwner.hobbies_interests)}" value="${currentOwner.hobbies_interests || ''}" onchange="updateOwner('hobbies_interests', this.value)">
                    </div>
                </div>

                <div class="section-title" style="margin-top: 30px;">Phone Numbers</div>
                <table class="phone-table">
                    <thead>
                        <tr>
                            <th>Label</th>
                            <th>Number</th>
                            <th style="width: 60px; text-align: center;">Call</th>
                            <th style="width: 60px; text-align: center;">Spoken</th>
                            <th style="width: 60px; text-align: center;">Delete</th>
                        </tr>
                    </thead>
                    <tbody id="phoneTableBody">
                        ${renderPhoneRows()}
                    </tbody>
                </table>
                <button class="btn add-phone-btn" onclick="addPhoneRow()">+ Add Phone</button>
                <div class="cell-only-row">
                    <label><input type="checkbox" ${currentOwner.call_with_cell_only ? 'checked' : ''} onchange="updateOwner('call_with_cell_only', this.checked)"> Call with cell only</label>
                </div>
                <div style="display: none;">
                    <div class="section-title" style="margin-top: 30px;">Status Tags</div>
                    <div id="ownerStatusTags" class="status-tags-container"></div>
                </div>
            `;

            centerPanel.innerHTML = ownerHeaderHtml + propertyHtml + ownerInfoHtml;

            // Post-render actions
            populateOwnerStatusDropdown();
            renderOwnerTags();
            updateMapForOwner();
            document.getElementById('logPropertyName').textContent = currentProperty ? currentProperty.address : 'N/A';
        }

        // Render Property-Specific Details
        function renderPropertyDetails() {
            if (!currentProperty) return '';

            const distinctLocations = [...new Set(allProperties.map(p => p.location).filter(Boolean))].sort();
            const locationOptionsHtml = distinctLocations.map(loc =>
                `<option value="${loc}" ${currentProperty.location === loc ? 'selected' : ''}>${loc}</option>`
            ).join('');

            return `
                <div class="property-header">
                    <div class="property-title">
                        ${currentProperty.address || 'No Address'}
                        <button class="phone-action-btn" style="color: #c0392b; margin-left: 15px;" onclick="deleteProperty(this)">üóëÔ∏è</button>
                    </div>
                    <div class="property-nav">
                        <button class="btn" style="background-color: #e67e22; color: white;" onclick="showTransferPropertyModal()">Transfer</button>
                        <button class="nav-btn" onclick="previousProperty()">‚óÄ</button>
                        <span class="property-counter">${currentPropertyIndex + 1} of ${ownerProperties.length}</span>
                        <button class="nav-btn" onclick="nextProperty()">‚ñ∂</button>
                    </div>
                </div>
                <div class="property-images">
                    <div class="image-container">
                        ${currentProperty.image_url_1 ? `<img src="${currentProperty.image_url_1}" alt="Property Image 1">` : 'Click + to add'}
                        <div class="image-actions">
                            <button onclick="showEditModal('property', 'image_url_1', 'Edit Image URL 1', 'Image URL', currentProperty.image_url_1)">‚ûï</button>
                            ${currentProperty.image_url_1 ? `<button onclick="updateProperty('image_url_1', null)">‚ùå</button>` : ''}
                        </div>
                    </div>
                    <div class="image-container">
                        ${currentProperty.image_url_2 ? `<img src="${currentProperty.image_url_2}" alt="Property Image 2">` : 'Click + to add'}
                        <div class="image-actions">
                            <button onclick="showEditModal('property', 'image_url_2', 'Edit Image URL 2', 'Image URL', currentProperty.image_url_2)">‚ûï</button>
                            ${currentProperty.image_url_2 ? `<button onclick="updateProperty('image_url_2', null)">‚ùå</button>` : ''}
                        </div>
                    </div>
                </div>
                <div class="link-buttons">
                    <div class="link-btn-group">
                        <a href="${currentProperty.costar_link || 'javascript:void(0)'}" target="_blank" class="link-btn ${currentProperty.costar_link ? 'costar' : 'no-link'}">CoStar</a>
                        <button class="link-action-btn" onclick="showEditModal('property', 'costar_link', 'Edit CoStar Link', 'URL', currentProperty.costar_link)">‚ûï</button>
                        ${currentProperty.costar_link ? `<button class="link-action-btn" onclick="updateProperty('costar_link', null)">‚ùå</button>` : ''}
                    </div>
                    <div class="link-btn-group">
                        <a href="${currentProperty.tps_link || 'javascript:void(0)'}" target="_blank" class="link-btn ${currentProperty.tps_link ? 'tps' : 'no-link'}">TPS</a>
                        <button class="link-action-btn" onclick="showEditModal('property', 'tps_link', 'Edit TPS Link', 'URL', currentProperty.tps_link)">‚ûï</button>
                        ${currentProperty.tps_link ? `<button class="link-action-btn" onclick="updateProperty('tps_link', null)">‚ùå</button>`: ''}
                    </div>
                    <div class="link-btn-group">
                        <a href="${currentProperty.llc_link || 'javascript:void(0)'}" target="_blank" class="link-btn ${currentProperty.llc_link ? 'llc' : 'no-link'}">LLC</a>
                        <button class="link-action-btn" onclick="showEditModal('property', 'llc_link', 'Edit LLC Link', 'URL', currentProperty.llc_link)">‚ûï</button>
                        ${currentProperty.llc_link ? `<button class="link-action-btn" onclick="updateProperty('llc_link', null)">‚ùå</button>` : ''}
                    </div>
                </div>
                <div class="section-title" style="margin-top: 30px;">Property Information</div>
                <div class="form-grid" style="gap: 8px 15px;">
                    <div class="form-group full-width">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.address)}" value="${currentProperty.address || ''}" onchange="updateProperty('address', this.value)">
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Property Name</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.property_name)}" value="${currentProperty.property_name || ''}" onchange="updateProperty('property_name', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">City</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.city)}" value="${currentProperty.city || ''}" onchange="updateProperty('city', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">State</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.state)}" value="${currentProperty.state || ''}" onchange="updateProperty('state', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ZIP</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.zip)}" value="${currentProperty.zip || ''}" onchange="updateProperty('zip', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Year Built</label>
                        <input type="number" class="form-input ${highlightField(currentProperty.built)}" value="${currentProperty.built || ''}" onchange="updateProperty('built', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Submarket</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.submarket)}" value="${currentProperty.submarket || ''}" onchange="updateProperty('submarket', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Units</label>
                        <input type="number" class="form-input ${highlightField(currentProperty.units)}" value="${currentProperty.units || ''}" onchange="updateProperty('units', this.value)">
                    </div>
                     <div class="form-group">
                        <label class="form-label">Property Type</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.property_type)}" value="${currentProperty.property_type || ''}" onchange="updateProperty('property_type', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <select class="form-input ${highlightField(currentProperty.location)}" onchange="updateProperty('location', this.value)">
                            <option value="">Select Location</option>
                            ${locationOptionsHtml}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">County</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.county_name)}" value="${currentProperty.county_name || ''}" onchange="updateProperty('county_name', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Zoning</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.zoning)}" value="${currentProperty.zoning || ''}" onchange="updateProperty('zoning', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Property Manager</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.property_manager_name)}" value="${currentProperty.property_manager_name || ''}" onchange="updateProperty('property_manager_name', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Parcel #</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.parcel_number)}" value="${currentProperty.parcel_number || ''}" onchange="updateProperty('parcel_number', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">CoStar #</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.costar_number)}" value="${currentProperty.costar_number || ''}" onchange="updateProperty('costar_number', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Land Area (SF)</label>
                        <input type="number" class="form-input ${highlightField(currentProperty.land_area_sf)}" value="${currentProperty.land_area_sf || ''}" onchange="updateProperty('land_area_sf', this.value)">
                    </div>
                     <div class="form-group">
                        <label class="form-label">Land Area (AC)</label>
                        <input type="number" class="form-input ${highlightField(currentProperty.land_area_ac)}" value="${currentProperty.land_area_ac || ''}" onchange="updateProperty('land_area_ac', this.value)">
                    </div>
                </div>

                <div class="section-title" style="margin-top: 30px;">Loan Information</div>
                 <div class="form-grid" style="gap: 8px 15px;">
                    <div class="form-group">
                        <label class="form-label">Interest Rate</label>
                        <input type="number" class="form-input ${highlightField(currentProperty.interest_rate)}" value="${currentProperty.interest_rate || ''}" onchange="updateProperty('interest_rate', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Loan Type</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.loan_type)}" value="${currentProperty.loan_type || ''}" onchange="updateProperty('loan_type', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Maturity Date</label>
                        <input type="date" class="form-input" value="${currentProperty.maturity_date || ''}" onchange="updateProperty('maturity_date', this.value)">
                    </div>
                </div>

                <div class="section-title" style="margin-top: 30px;">Sale Information</div>
                <div class="form-grid" style="gap: 8px 15px;">
                    <div class="form-group">
                        <label class="form-label">For Sale Status</label>
                        <select class="form-input" onchange="updateProperty('for_sale_status', this.value)" style="background-color: ${currentProperty.for_sale_status === 'Y' ? '#E8F5E9' : '#f0f0f0'};">
                            <option value="N" ${currentProperty.for_sale_status !== 'Y' ? 'selected' : ''}>No</option>
                            <option value="Y" ${currentProperty.for_sale_status === 'Y' ? 'selected' : ''}>Yes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">For Sale Price</label>
                        <input type="number" class="form-input ${highlightField(currentProperty.for_sale_price)}" value="${currentProperty.for_sale_price || ''}" onchange="updateProperty('for_sale_price', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Day Listed</label>
                        <input type="date" class="form-input" value="${currentProperty.day_listed || ''}" onchange="updateProperty('day_listed', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cap Rate</label>
                        <input type="number" class="form-input ${highlightField(currentProperty.cap_rate)}" value="${currentProperty.cap_rate || ''}" onchange="updateProperty('cap_rate', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Price / Unit</label>
                        <input type="number" class="form-input ${highlightField(currentProperty.price_unit)}" value="${currentProperty.price_unit || ''}" onchange="updateProperty('price_unit', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Sale Price</label>
                        <input type="number" class="form-input ${highlightField(currentProperty.last_sale_price)}" value="${currentProperty.last_sale_price || ''}" onchange="updateProperty('last_sale_price', this.value)">
                    </div>
                     <div class="form-group">
                        <label class="form-label">Last Sale Date</label>
                        <input type="date" class="form-input" value="${currentProperty.last_sale_date || ''}" onchange="updateProperty('last_sale_date', this.value)">
                    </div>
                </div>
            `;
        }

        // Render phone rows
        function renderPhoneRows() {
            if (!currentOwner) return '';
            let html = '';
            let hasContent = true;
            for (let i = 1; i <= 5 && hasContent; i++) {
                const label = currentOwner[`phone_label_${i}`] || '';
                const number = currentOwner[`phone_number_${i}`] || '';
                const spoken = currentOwner[`spoken_${i}`] || false;

                // Stop rendering rows if the current one is empty (unless it's the first)
                if (i > 1 && !number && !label) {
                    hasContent = false;
                    continue;
                }

                html += `
                    <tr class="${i > 1 && !currentOwner[`phone_number_${i-1}`] ? 'new-row-highlight' : ''}">
                        <td>
                            <input type="text" class="form-input ${highlightField(label)}" placeholder="Label (e.g., Mobile)" value="${label}"
                                onchange="updateOwner('phone_label_${i}', this.value)">
                        </td>
                        <td>
                            <input type="text" class="form-input ${highlightField(number)}" placeholder="Number" value="${number}"
                                onchange="updateOwner('phone_number_${i}', this.value)">
                        </td>
                        <td style="text-align: center;">
                            <a href="tel:${number}" title="Call ${number}" class="phone-action-btn" style="text-decoration: none;">üìû</a>
                        </td>
                        <td style="text-align: center;">
                            <input type="checkbox" ${spoken ? 'checked' : ''}
                                onchange="updateOwner('spoken_${i}', this.checked)">
                        </td>
                        <td style="text-align: center;">
                            <button class="phone-action-btn" onclick="deletePhone(${i})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }
            return html;
        }

        // Render no properties message
        function renderNoProperties() {
            currentProperty = null;
            renderCenterPanel();
        }

        // Navigation functions
        function previousProperty() {
            if (ownerProperties.length === 0) return;
            currentPropertyIndex = (currentPropertyIndex - 1 + ownerProperties.length) % ownerProperties.length;
            currentProperty = ownerProperties[currentPropertyIndex];
            renderCenterPanel();
        }

        function nextProperty() {
            if (ownerProperties.length === 0) return;
            currentPropertyIndex = (currentPropertyIndex + 1) % ownerProperties.length;
            currentProperty = ownerProperties[currentPropertyIndex];
            renderCenterPanel();
        }

        // Update Property
        async function updateProperty(field, value) {
            try {
                const { error } = await supabase
                    .from('properties')
                    .update({ [field]: value })
                    .eq('id', currentProperty.id);

                if (error) throw error;

                currentProperty[field] = value;

                const index = allProperties.findIndex(p => p.id === currentProperty.id);
                if (index !== -1) allProperties[index][field] = value;

                await renderCenterPanel();
            } catch (error) {
                console.error('Error updating property:', error);
            }
        }

        // Update Owner
        async function updateOwner(field, value) {
            // Special handling for next_follow_up for optimistic UI update
            if (field === 'next_follow_up') {
                const oldDate = currentOwner.next_follow_up;
                const ownerIndex = allOwners.findIndex(o => o.id === currentOwner.id);

                // If value is an empty string, it means the date was cleared. Use null for the database.
                const valueForDb = value === '' ? null : value;

                // 1. Optimistically update local data
                currentOwner.next_follow_up = value;
                if (ownerIndex !== -1) allOwners[ownerIndex].next_follow_up = value;

                // 2. Immediately refresh the follow-up list
                loadFollowUpTasks();

                try {
                    // 3. Update database
                    const { data, error } = await supabase
                        .from('owners')
                        .update({ next_follow_up: valueForDb })
                        .eq('id', currentOwner.id)
                        .select()
                        .single();

                    if (error) throw error;

                    // 4. On success, confirm data and re-render the center panel
                    Object.assign(currentOwner, data);
                    if (ownerIndex !== -1) Object.assign(allOwners[ownerIndex], data);
                    await renderCenterPanel();

                } catch (error) {
                    console.error('Error updating next_follow_up:', error);
                    alert('Failed to update follow-up date. Reverting changes.');

                    // 5. On failure, revert local data
                    currentOwner.next_follow_up = oldDate;
                    if (ownerIndex !== -1) allOwners[ownerIndex].next_follow_up = oldDate;

                    // 6. Refresh UI back to its original state
                    loadFollowUpTasks();
                    await renderCenterPanel();
                }
                return; // End execution for this special case
            }

            // Original logic for all other fields
            try {
                const { data, error } = await supabase
                    .from('owners')
                    .update({ [field]: value })
                    .eq('id', currentOwner.id)
                    .select();

                if (error) throw error;

                // Update local objects with the returned, confirmed data
                Object.assign(currentOwner, data[0]);
                const index = allOwners.findIndex(o => o.id === currentOwner.id);
                if (index !== -1) Object.assign(allOwners[index], data[0]);

                if (field === 'marker_pin' || field === 'status_tags') {
                    renderOwnersList();
                }

                await renderCenterPanel();
            } catch (error) {
                console.error('Error updating owner:', error);
            }
        }

        // Call Phone
        function callPhone(number) {
            if (number) {
                window.open(`tel:${number}`);
            }
        }

        // Render Communication Logs
        function renderCommunicationLogs() {
            if (!currentOwner) return;
            const logList = document.getElementById('logList');
            const ownerLogs = allLogs.filter(log => log.owner_id === currentOwner.id).sort((a,b) => new Date(b.date) - new Date(a.date));

            if (ownerLogs.length === 0) {
                logList.innerHTML = '<div class="no-logs">No communication history</div>';
                return;
            }

            logList.innerHTML = ownerLogs.map(log => `
                <div class="log-item">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <div class="log-date">${formatDate(log.date)}</div>
                        <button class="phone-action-btn" style="font-size: 14px;" onclick='showEditLogModal(${JSON.stringify(log)})'>‚úèÔ∏è Edit</button>
                    </div>
                    <div class="log-type">${log.type || 'Note'}</div>
                    <div class="log-notes">${log.notes || 'No notes'}</div>
                </div>
            `).join('');
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'No date';
            const date = new Date(dateString);
            // Use timeZone: 'UTC' to prevent the date from being shifted to the previous day
            // due to the user's local timezone.
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', timeZone: 'UTC' });
        }

        // Delete Property
        async function deleteProperty(button) {
            if (!currentProperty) return;

            if (!button.classList.contains('are-you-sure')) {
                button.classList.add('are-you-sure');
                button.textContent = 'Confirm?';
                setTimeout(() => {
                    button.classList.remove('are-you-sure');
                    button.textContent = 'üóëÔ∏è';
                }, 3000);
                return;
            }

            try {
                const { error } = await supabase
                    .from('properties')
                    .delete()
                    .eq('id', currentProperty.id);

                if (error) throw error;

                allProperties = allProperties.filter(p => p.id !== currentProperty.id);
                ownerProperties = ownerProperties.filter(p => p.id !== currentProperty.id);

                if (ownerProperties.length > 0) {
                    currentPropertyIndex = Math.max(0, currentPropertyIndex - 1);
                    currentProperty = ownerProperties[currentPropertyIndex];
                } else {
                    currentProperty = null;
                }
                await renderCenterPanel();
            } catch (error) {
                console.error('Error deleting property:', error);
            }
        }

        async function deletePhone(index) {
            // Use a standard confirm dialog for single-click confirmation
            if (!confirm('Are you sure you want to delete this phone number?')) {
                return;
            }

            const updates = {};
            // Shift subsequent phone numbers up
            for (let i = index; i < 5; i++) {
                updates[`phone_label_${i}`] = currentOwner[`phone_label_${i + 1}`] || null;
                updates[`phone_number_${i}`] = currentOwner[`phone_number_${i + 1}`] || null;
                updates[`spoken_${i}`] = currentOwner[`spoken_${i + 1}`] || false;
            }
            // Clear the last phone number fields
            updates['phone_label_5'] = null;
            updates['phone_number_5'] = null;
            updates['spoken_5'] = false;

            try {
                const { error } = await supabase
                    .from('owners')
                    .update(updates)
                    .eq('id', currentOwner.id);

                if (error) throw error;

                // Update local owner object to match
                Object.assign(currentOwner, updates);

                await renderCenterPanel();

            } catch (error) {
                console.error('Error deleting phone:', error);
            }
        }

        // Modal Functions
        function showEditModal(entityType, field, title, label, currentValue) {
            document.getElementById('editModalEntityType').value = entityType;
            document.getElementById('editModalField').value = field;
            document.getElementById('editModalTitle').textContent = title;
            document.getElementById('editModalLabel').textContent = label;
            document.getElementById('editModalInput').value = currentValue || '';
            document.getElementById('editModal').classList.add('active');
            document.getElementById('editModalInput').focus();
        }

        async function saveFromEditModal() {
            const entityType = document.getElementById('editModalEntityType').value;
            const field = document.getElementById('editModalField').value;
            const value = document.getElementById('editModalInput').value.trim();

            if (entityType === 'property') {
                await updateProperty(field, value);
            } else if (entityType === 'owner') {
                await updateOwner(field, value);
            }

            closeModal('editModal');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showAddOwnerModal() {
            document.getElementById('addOwnerModal').classList.add('active');
        }

        function showAddPropertyModal() {
            document.getElementById('addPropertyModal').classList.add('active');
            filterOwnerSearch('newPropertyOwner'); // To show initial list
        }

        function showAddLogModal() {
            if (!currentOwner) return;
            document.getElementById('addLogModal').classList.add('active');
        }

        function showEditLogModal(log) {
            document.getElementById('editLogId').value = log.id;
            document.getElementById('editLogType').value = log.type;
            document.getElementById('editLogNotes').value = log.notes;
            // Ensure date is in YYYY-MM-DD format for the input
            document.getElementById('editLogDate').value = log.date.split('T')[0];
            document.getElementById('editLogModal').classList.add('active');
        }

        async function updateLog() {
            const logId = document.getElementById('editLogId').value;
            const updates = {
                type: document.getElementById('editLogType').value,
                notes: document.getElementById('editLogNotes').value.trim(),
                date: document.getElementById('editLogDate').value,
            };

            try {
                const { data, error } = await supabase
                    .from('communication_logs')
                    .update(updates)
                    .eq('id', logId)
                    .select()
                    .single();

                if (error) throw error;

                // Update the log in the global and current owner's log arrays
                const logIndex = allLogs.findIndex(l => l.id === logId);
                if (logIndex > -1) {
                    allLogs[logIndex] = data;
                }
                const ownerLogIndex = currentOwner.logs.findIndex(l => l.id === logId);
                if (ownerLogIndex > -1) {
                    currentOwner.logs[ownerLogIndex] = data;
                }

                renderCommunicationLogs();
                closeModal('editLogModal');

            } catch (error) {
                console.error('Error updating log:', error);
            }
        }

        async function deleteLog() {
            const logId = document.getElementById('editLogId').value;
            if (!logId) return;

            if (confirm('Are you sure you want to delete this log entry?')) {
                try {
                    const { error } = await supabase
                        .from('communication_logs')
                        .delete()
                        .eq('id', logId);

                    if (error) throw error;

                    // Remove from local arrays
                    allLogs = allLogs.filter(l => l.id !== logId);
                    if (currentOwner) {
                        currentOwner.logs = currentOwner.logs.filter(l => l.id !== logId);
                    }

                    renderCommunicationLogs();
                    closeModal('editLogModal');

                } catch (error) {
                    console.error('Error deleting log:', error);
                    alert('Failed to delete log entry.');
                }
            }
        }

        // Add New Owner
        async function addNewOwner() {
            const name = document.getElementById('newOwnerName').value.trim();
            if (!name) return;

            try {
                const { data, error } = await supabase
                    .from('owners')
                    .insert([{
                        owner_name: name,
                        owner_email: document.getElementById('newOwnerEmail').value.trim(),
                        owner_address: document.getElementById('newOwnerAddress').value.trim(),
                        marker_pin: document.getElementById('newOwnerStatus').value
                    }])
                    .select();

                if (error) throw error;

                allOwners.push(data[0]);
                renderOwnersList();

                closeModal('addOwnerModal');

                // Clear form
                document.getElementById('newOwnerName').value = '';
                document.getElementById('newOwnerEmail').value = '';
                document.getElementById('newOwnerAddress').value = '';

            } catch (error) {
                console.error('Error adding owner:', error);
            }
        }

        // Add New Property
        async function addNewProperty() {
            const ownerId = document.getElementById('newPropertyOwner').value;
            const address = document.getElementById('newPropertyAddress').value.trim();

            if (!ownerId || !address) return;

            try {
                const owner = allOwners.find(o => o.id === ownerId);

                const { data, error } = await supabase
                    .from('properties')
                    .insert([{
                        owner_id: ownerId,
                        owner_name: owner?.owner_name,
                        address: address,
                        property_name: document.getElementById('newPropertyName').value.trim(),
                        city: document.getElementById('newPropertyCity').value.trim(),
                        state: document.getElementById('newPropertyState').value.trim(),
                        zip: document.getElementById('newPropertyZip').value.trim()
                    }])
                    .select();

                if (error) throw error;

                allProperties.push(data[0]);

                // If currently viewed owner is the one we added to, refresh their view
                if (currentOwner && currentOwner.id === ownerId) {
                   await selectOwner(ownerId);
                }

                closeModal('addPropertyModal');

                // Clear form
                document.getElementById('newPropertyOwner').value = '';
                document.getElementById('newPropertyOwnerSearch').value = '';
                document.getElementById('newPropertyAddress').value = '';
                document.getElementById('newPropertyName').value = '';
                document.getElementById('newPropertyCity').value = '';
                document.getElementById('newPropertyState').value = '';
                document.getElementById('newPropertyZip').value = '';

            } catch (error) {
                console.error('Error adding property:', error);
            }
        }

        // Add New Log
        async function addNewLog() {
            const type = document.getElementById('newLogType').value;
            const notes = document.getElementById('newLogNotes').value.trim();
            const followUpDate = document.getElementById('newLogFollowUp').value;
            const logDate = document.getElementById('datePicker').value; // Get date from datePicker

            if (!type) return; // No alert, just exit

            try {
                // 1. Insert the new communication log
                const { data: newLog, error: logError } = await supabase
                    .from('communication_logs')
                    .insert([{
                        owner_id: currentOwner.id,
                        owner_name: currentOwner.owner_name,
                        date: logDate, // Use the selected date
                        type: type,
                        notes: notes
                    }])
                    .select()
                    .single();

                if (logError) throw logError;

                // 2. Conditionally update the owner record
                const ownerUpdates = {};
                // Only update last_spoken if the log type is 'Call'
                if (type === 'Call') {
                    ownerUpdates.last_spoken = logDate;
                }
                if (followUpDate) {
                    ownerUpdates.next_follow_up = followUpDate;
                }

                // Only perform the update if there's something to change
                if (Object.keys(ownerUpdates).length > 0) {
                    const { data: updatedOwner, error: ownerError } = await supabase
                        .from('owners')
                        .update(ownerUpdates)
                        .eq('id', currentOwner.id)
                        .select()
                        .single();

                    if (ownerError) throw ownerError;

                    // Update local owner object with confirmed data
                    Object.assign(currentOwner, updatedOwner);
                    const index = allOwners.findIndex(o => o.id === currentOwner.id);
                    if (index !== -1) Object.assign(allOwners[index], updatedOwner);
                }

                // 3. Update local log state and UI
                allLogs.push(newLog); // Add to the global logs array
                currentOwner.logs.unshift(newLog); // Add to the owner's specific logs

                renderCommunicationLogs();

                // Refresh follow-up tasks if date was changed
                if (followUpDate) {
                    loadFollowUpTasks();
                }

                await renderCenterPanel();

                closeModal('addLogModal');
                document.getElementById('newLogNotes').value = '';
                document.getElementById('newLogFollowUp').value = '';

            } catch (error) {
                console.error('Error adding log:', error);
            }
        }

        function populateStatusDropdowns() {
            const dropdowns = [
                { id: 'newOwnerStatus', default: '' },
                { id: 'filterStatus', default: 'All Statuses' }
            ];

            dropdowns.forEach(d => {
                const select = document.getElementById(d.id);
                if (!select) return;

                select.innerHTML = d.default ? `<option value="">${d.default}</option>` : '';

                for (const status in STATUS_OPTIONS) {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    option.style.color = STATUS_OPTIONS[status];
                    select.appendChild(option);
                }
            });
        }

        // Populate Filter Dropdowns with distinct values
        function populateFilterDropdowns() {
            const populate = (id, items, defaultOption) => {
                const select = document.getElementById(id);
                const uniqueItems = [...new Set(items.filter(item => item))].sort();
                select.innerHTML = `<option value="">${defaultOption}</option>` +
                    uniqueItems.map(item => `<option value="${item}">${item}</option>`).join('');
            };

            const locations = allProperties.map(p => p.location);
            populate('filterLocation', locations, 'All Locations');

            const cities = allProperties.map(p => p.city);
            populate('filterCity', cities, 'All Cities');

            const submarkets = allProperties.map(p => p.submarket);
            populate('filterSubmarket', submarkets, 'All Submarkets');

            const zips = allProperties.map(p => p.zip);
            populate('filterZip', zips, 'All Zips');

            const statuses = allOwners.map(o => o.marker_pin);
            populate('filterStatus', statuses, 'All Statuses');
        }

        // Search and Filter (Client-Side)
        function applyFiltersAndSearch() {
            let filteredOwners = [...allOwners];
            const query = document.getElementById('searchInput').value.toLowerCase().trim();

            // Filter logic
            const location = document.getElementById('filterLocation').value;
            const city = document.getElementById('filterCity').value;
            const submarket = document.getElementById('filterSubmarket').value;
            const zip = document.getElementById('filterZip').value;
            const yearMin = document.getElementById('filterYearMin').value;
            const yearMax = document.getElementById('filterYearMax').value;
            const unitsMin = document.getElementById('filterUnitsMin').value;
            const unitsMax = document.getElementById('filterUnitsMax').value;
            const status = document.getElementById('filterStatus').value;

            const hasPropertyFilters = [location, city, submarket, zip, yearMin, yearMax, unitsMin, unitsMax].some(f => f);

            if (status) {
                filteredOwners = filteredOwners.filter(owner => owner.marker_pin === status);
            }

            if (hasPropertyFilters) {
                const matchingOwnerIds = new Set(allProperties.filter(p => {
                    if (location && p.location !== location) return false;
                    if (city && p.city !== city) return false;
                    if (submarket && p.submarket !== submarket) return false;
                    if (zip && p.zip != zip) return false;
                    if (yearMin && p.built < yearMin) return false;
                    if (yearMax && p.built > yearMax) return false;
                    if (unitsMin && p.units < unitsMin) return false;
                    if (unitsMax && p.units > unitsMax) return false;
                    return true;
                }).map(p => p.owner_id));

                filteredOwners = filteredOwners.filter(owner => matchingOwnerIds.has(owner.id));
            }

            // Search logic
            if (query) {
                const propertyOwnerIds = new Set(allProperties.filter(p => (p.address || '').toLowerCase().includes(query)).map(p => p.owner_id));
                filteredOwners = filteredOwners.filter(owner => {
                    const nameMatch = (owner.owner_name || '').toLowerCase().includes(query);
                    return nameMatch || propertyOwnerIds.has(owner.id);
                });
            }

            renderOwnersList(filteredOwners);
        }

        function performSearch() {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => {
                applyFiltersAndSearch();
            }, 250); // 250ms debounce delay
        }

        // Toggle Filters
        function toggleFilters() {
            const panel = document.getElementById('filterPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // Apply Filters
        function applyFilters() {
            applyFiltersAndSearch();
        }

        // Clear Filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterLocation').value = '';
            document.getElementById('filterCity').value = '';
            document.getElementById('filterSubmarket').value = '';
            document.getElementById('filterZip').value = '';
            document.getElementById('filterYearMin').value = '';
            document.getElementById('filterYearMax').value = '';
            document.getElementById('filterUnitsMin').value = '';
            document.getElementById('filterUnitsMax').value = '';
            document.getElementById('filterStatus').value = '';
            document.querySelectorAll('#filterStatusTags .active').forEach(tag => tag.classList.remove('active'));
            applyFiltersAndSearch();
        }

        // Show Status Breakdown
        function showStatusBreakdown() {
            const statusCounts = {};
            allOwners.forEach(owner => {
                const status = owner.marker_pin || 'Unspecified';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            document.getElementById('statusModal').classList.add('active');

            const ctx = document.getElementById('statusChart').getContext('2d');

            if(window.statusChartInstance) {
                window.statusChartInstance.destroy();
            }

            window.statusChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: Object.keys(statusCounts).map(status => STATUS_OPTIONS[status] || '#6c757d')
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            const stats = Object.entries(statusCounts)
                .map(([status, count]) => {
                    const percentage = ((count / allOwners.length) * 100).toFixed(1);
                    return `<div style="padding: 10px; background: #f8f9fa; margin-bottom: 5px; border-radius: 4px;">
                        <strong>${status}:</strong> ${count} owners (${percentage}%)
                    </div>`;
                }).join('');

            document.getElementById('statusStats').innerHTML = stats;
        }

        // Call Tracker
        async function showCallTracker() {
            document.getElementById('callTrackerModal').classList.add('active');

            const callLogs = allLogs.filter(log => log.type === 'Call');
            const callsByDay = callLogs.reduce((acc, log) => {
                const date = log.date.split('T')[0];
                acc[date] = (acc[date] || 0) + 1;
                return acc;
            }, {});

            const labels = [...Array(30)].map((_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - i);
                return d.toISOString().split('T')[0];
            }).reverse();

            const data = labels.map(label => callsByDay[label] || 0);

            const ctx = document.getElementById('callChart').getContext('2d');
            if (window.callChartInstance) {
                window.callChartInstance.destroy();
            }
            window.callChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Calls per Day (Last 30 Days)',
                        data: data,
                        backgroundColor: 'rgba(43, 90, 168, 0.7)',
                    }]
                },
                options: {
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            }
                        },
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Status Tags
        function renderFilterTags() {
            const container = document.getElementById('filterStatusTags');
            container.innerHTML = STATUS_TAGS.map(tag =>
                `<button class="status-tag" data-tag="${tag}" onclick="toggleFilterTag(this)">${tag}</button>`
            ).join('');
        }

        function toggleFilterTag(element) {
            element.classList.toggle('active');
            applyFiltersAndSearch();
        }

        function renderOwnerTags() {
            const container = document.getElementById('ownerStatusTags');
            if (!container) return;
            container.innerHTML = STATUS_TAGS.map(tag => {
                const isActive = (currentOwner.status_tags || []).includes(tag);
                return `<button class="status-tag ${isActive ? 'active' : ''}" onclick="toggleOwnerTag('${tag}')">${tag}</button>`
            }).join('');
        }

        async function toggleOwnerTag(tag) {
            const currentTags = currentOwner.status_tags || [];
            const tagIndex = currentTags.indexOf(tag);
            if (tagIndex > -1) {
                currentTags.splice(tagIndex, 1);
            } else {
                currentTags.push(tag);
            }
            await updateOwner('status_tags', currentTags);
        }

        // Owner Search Component Logic for modals
        function filterOwnerSearch(prefix) {
            clearTimeout(ownerSearchDebounceTimer);
            ownerSearchDebounceTimer = setTimeout(async () => {
                const input = document.getElementById(`${prefix}Search`);
                const resultsContainer = document.getElementById(`${prefix}SearchResults`);
                const query = input.value.trim();

                if (query.length < 2) {
                    resultsContainer.innerHTML = '';
                    resultsContainer.style.display = 'none';
                    return;
                }

                resultsContainer.innerHTML = '<div class="owner-search-item">Searching...</div>';
                resultsContainer.style.display = 'block';

                try {
                    const { data, error } = await supabase
                        .from('owners')
                        .select('id, owner_name')
                        .ilike('owner_name', `%${query}%`);

                    if (error) throw error;

                    if (data.length === 0) {
                        resultsContainer.innerHTML = '<div class="owner-search-item">No results</div>';
                        return;
                    }

                    resultsContainer.innerHTML = ''; // Clear "Searching..."
                    data.forEach(owner => {
                         if (currentOwner && owner.id === currentOwner.id) return; // Exclude current owner
                        const item = document.createElement('div');
                        item.className = 'owner-search-item';
                        item.textContent = owner.owner_name;
                        item.onclick = () => selectOwnerFromSearch(prefix, owner.owner_name, owner.id);
                        resultsContainer.appendChild(item);
                    });

                } catch (error) {
                    console.error('Error searching for owner:', error);
                    resultsContainer.innerHTML = '<div class="owner-search-item">Error searching</div>';
                }
            }, 300); // 300ms debounce
        }

        function selectOwnerFromSearch(prefix, name, id) {
            document.getElementById(`${prefix}Search`).value = name;
            document.getElementById(prefix).value = id;
            document.getElementById(`${prefix}SearchResults`).style.display = 'none';
        }


        // Owner/Property Management
        async function deleteOwner(button) {
            if (!currentOwner) return;

            if (!button.classList.contains('are-you-sure')) {
                button.classList.add('are-you-sure');
                button.textContent = 'Confirm?';
                setTimeout(() => {
                    button.classList.remove('are-you-sure');
                    button.textContent = 'üóëÔ∏è';
                }, 3000);
                return;
            }

            try {
                // This should ideally be a transaction in a real-world scenario
                await supabase.from('communication_logs').delete().eq('owner_id', currentOwner.id);
                await supabase.from('properties').delete().eq('owner_id', currentOwner.id);
                await supabase.from('owners').delete().eq('id', currentOwner.id);

                window.location.reload(); // Simple way to refresh state
            } catch (error) {
                console.error('Error deleting owner:', error);
            }
        }

        function showTransferPropertyModal() {
            if (!currentProperty) return;
            document.getElementById('transferPropertyModal').classList.add('active');
            filterOwnerSearch('transferOwner');
        }

        async function transferProperty() {
            const newOwnerId = document.getElementById('transferOwner').value;
            if (!newOwnerId) return;

            const oldOwnerId = currentOwner.id;

            // Reassign owner_id and owner_name for the property
            const newOwner = allOwners.find(o => o.id === newOwnerId);
            await updateProperty('owner_id', newOwnerId);
            await updateProperty('owner_name', newOwner.owner_name);

            closeModal('transferPropertyModal');

            // Refresh the old owner's view (property will be gone)
            await selectOwner(oldOwnerId);
        }

        function addPhoneRow() {
            const phoneTableBody = document.getElementById('phoneTableBody');
            let nextIndex = -1;
            for (let i = 1; i <= 5; i++) {
                if (!currentOwner[`phone_number_${i}`]) {
                    nextIndex = i;
                    break;
                }
            }

            if (nextIndex === -1) return;

            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>
                    <input type="text" class="form-input highlight-yellow" placeholder="Label (e.g., Mobile)"
                        onchange="updateOwner('phone_label_${nextIndex}', this.value)">
                </td>
                <td>
                    <input type="text" class="form-input highlight-yellow" placeholder="Number"
                        onchange="updateOwner('phone_number_${nextIndex}', this.value)">
                </td>
                <td style="text-align: center;">
                    <button class="phone-action-btn" onclick="callPhone(this.parentElement.previousElementSibling.firstElementChild.value)">üìû</button>
                </td>
                <td style="text-align: center;">
                    <input type="checkbox" onchange="updateOwner('spoken_${nextIndex}', this.checked)">
                </td>
                <td style="text-align: center;">
                    <button class="phone-action-btn" onclick="deletePhone(${nextIndex})">üóëÔ∏è</button>
                </td>
            `;
            phoneTableBody.appendChild(newRow);
        }
    </script>
</body>
</html>
