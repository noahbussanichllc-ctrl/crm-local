<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM - Property Owner Management</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        /* Top Navigation Bar */
        .top-bar {
            background: #2B5AA8;
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .search-box {
            position: relative;
            flex: 0 0 300px;
        }

        .search-box input {
            width: 100%;
            padding: 8px 35px 8px 12px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-box button {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: #2B5AA8;
            cursor: pointer;
            font-size: 18px;
        }

        .date-picker {
            padding: 8px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-filter {
            background: #5B9BD5;
            color: white;
        }

        .btn-status {
            background: #70AD47;
            color: white;
        }

        .btn-call {
            background: #FF8C42;
            color: white;
        }

        .btn-add-owner {
            background: #70AD47;
            color: white;
            margin-left: auto;
        }

        .btn-add-property {
            background: #FF8C42;
            color: white;
        }

        /* Main Layout */
        .container {
            display: flex;
            height: calc(100vh - 60px);
        }

        /* Left Panel - Owners List */
        .left-panel {
            width: 320px;
            background: white;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            font-weight: 600;
            font-size: 16px;
            color: #2B5AA8;
            position: sticky;
            top: 0;
            z-index: 10;
            background: white;
        }

        .owners-list {
            flex: 1;
            overflow-y: auto;
        }

        .owner-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }

        .owner-item:hover {
            background: #f8f9fa;
        }

        .owner-item.active {
            background: #E8F0FE;
            border-left: 3px solid #2B5AA8;
        }

        .owner-status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .owner-info {
            flex: 1;
            min-width: 0;
        }

        .owner-name {
            font-weight: 500;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .owner-properties {
            font-size: 12px;
            color: #666;
        }

        .follow-up-section {
            border-top: 2px solid #ddd;
            background: #f8f9fa;
        }

        /* Center Panel - Property Details */
        .center-panel {
            flex: 1;
            background: white;
            overflow-y: auto;
            padding: 20px;
        }

        .property-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .property-title {
            font-size: 24px;
            font-weight: 600;
            color: #2B5AA8;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .property-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .property-counter {
            color: #666;
            font-size: 14px;
        }

        .nav-btn {
            background: #2B5AA8;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
        }

        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-star {
            background: #FFC107;
            color: white;
        }

        .btn-delete {
            background: #DC3545;
            color: white;
        }

        .property-images {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .image-container {
            aspect-ratio: 16/9;
            background: #f0f0f0;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
            position: relative;
        }

        .image-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
            background: rgba(0,0,0,0.5);
            padding: 4px;
            border-radius: 4px;
        }
        .image-actions button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }


        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #2B5AA8;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #E8F0FE;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
            text-align: center;
            font-weight: 500;
        }

        .form-input {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #2B5AA8;
            box-shadow: 0 0 0 2px rgba(43, 90, 168, 0.1);
        }

        .form-input.highlight-green {
            background: #E8F5E9;
        }

        .form-input.highlight-yellow {
            background: #FFF9E6;
        }

        .link-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .link-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .link-btn.costar {
            background: #2B5AA8;
            color: white;
        }

        .link-btn.no-link {
            background: #f0f0f0;
            color: #999;
            cursor: not-allowed;
        }

        .link-btn-group {
            flex: 1;
            display: flex;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        .link-action-btn {
            background: #eee;
            border: none;
            border-left: 1px solid #ddd;
            padding: 0 10px;
            cursor: pointer;
        }
        .link-action-btn:hover {
            background: #ddd;
        }

        .phone-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .phone-table th {
            background: #f8f9fa;
            padding: 8px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
        }

        .phone-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .phone-table input[type="text"] {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 13px;
        }

        .phone-table input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .phone-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
        }

        .add-phone-btn {
            margin-top: 10px;
            background: #70AD47;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .cell-only-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            justify-content: flex-end;
        }

        /* Right Panel - Map & Logs */
        .right-panel {
            width: 400px;
            background: white;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        #map {
            height: 300px;
            border-bottom: 1px solid #ddd;
        }

        .log-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .log-header {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-title {
            font-weight: 600;
            color: #2B5AA8;
        }

        .log-property-name {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .btn-log-call {
            background: #2B5AA8;
            color: white;
        }

        .log-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .log-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #2B5AA8;
        }

        .log-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .log-type {
            font-weight: 600;
            color: #2B5AA8;
            margin-bottom: 6px;
        }

        .log-notes {
            font-size: 13px;
            color: #333;
            line-height: 1.4;
        }

        .no-logs {
            text-align: center;
            color: #999;
            padding: 40px 20px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #2B5AA8;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        .btn-submit {
            background: #2B5AA8;
            color: white;
        }

        /* Filter Panel */
        .filter-panel {
            background: white;
            padding: 20px;
            margin: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .status-tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .status-tag {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 15px;
            cursor: pointer;
            background: #f8f9fa;
            font-size: 12px;
            transition: all 0.2s;
        }
        .status-tag.active {
            background: #2B5AA8;
            color: white;
            border-color: #2B5AA8;
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Responsive adjustments */
        @media (max-width: 1400px) {
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .chart-container {
            max-width: 800px;
            margin: 20px auto;
        }

        select.form-input {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <div class="top-bar">
        <div class="search-box">
            <input type="text" id="searchInput" oninput="performSearch()" placeholder="Search Owner or Address...">
        </div>
        <input type="date" id="datePicker" class="date-picker">
        <button class="btn btn-filter" onclick="toggleFilters()">‚ñº Filter Properties</button>
        <button class="btn btn-status" onclick="showStatusBreakdown()">üìä Status Breakdown</button>
        <button class="btn btn-call" onclick="showCallTracker()">üìû Call Tracker</button>
        <button class="btn btn-add-owner" onclick="showAddOwnerModal()">+ Add Owner</button>
        <button class="btn btn-add-property" onclick="showAddPropertyModal()">+ Add Property</button>
    </div>

    <!-- Filter Panel (Initially Hidden) -->
    <div id="filterPanel" style="display: none;">
        <div class="filter-panel">
            <h3>Filter Properties</h3>
            <div class="filter-grid">
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <select id="filterLocation" class="form-input" onchange="applyFilters()">
                        <option value="">All Locations</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">City</label>
                    <input type="text" id="filterCity" class="form-input" placeholder="City" oninput="applyFilters()">
                </div>
                <div class="form-group">
                    <label class="form-label">Submarket</label>
                    <input type="text" id="filterSubmarket" class="form-input" placeholder="Submarket" oninput="applyFilters()">
                </div>
                <div class="form-group">
                    <label class="form-label">ZIP</label>
                    <input type="text" id="filterZip" class="form-input" placeholder="ZIP" oninput="applyFilters()">
                </div>
                <div class="form-group">
                    <label class="form-label">Year Built (Min)</label>
                    <input type="number" id="filterYearMin" class="form-input" placeholder="Min Year" oninput="applyFilters()">
                </div>
                <div class="form-group">
                    <label class="form-label">Year Built (Max)</label>
                    <input type="number" id="filterYearMax" class="form-input" placeholder="Max Year" oninput="applyFilters()">
                </div>
                <div class="form-group">
                    <label class="form-label">Units (Min)</label>
                    <input type="number" id="filterUnitsMin" class="form-input" placeholder="Min Units" oninput="applyFilters()">
                </div>
                <div class="form-group">
                    <label class="form-label">Units (Max)</label>
                    <input type="number" id="filterUnitsMax" class="form-input" placeholder="Max Units" oninput="applyFilters()">
                </div>
                <div class="form-group">
                    <label class="form-label">Owner Status</label>
                    <select id="filterStatus" class="form-input" onchange="applyFilters()">
                        <option value="">All Statuses</option>
                    </select>
                </div>
                 <div class="form-group" style="grid-column: span 3;">
                    <label class="form-label">Status Tags</label>
                    <div id="filterStatusTags" class="status-tags-container"></div>
                </div>
            </div>
            <div style="margin-top: 15px; text-align: right;">
                <button class="btn btn-cancel" onclick="clearFilters()">Clear Filters</button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Left Panel: Owners List -->
        <div class="left-panel">
            <div class="panel-header">
                Owners (<span id="ownerCount">0</span>)
            </div>
            <div class="owners-list" id="ownersList">
                <div class="loading">Loading owners...</div>
            </div>
            <div class="follow-up-section">
                <div class="panel-header">Follow-Up Tasks (0)</div>
                <div style="padding: 15px; color: #666; font-size: 14px;">
                    No tasks found.
                </div>
            </div>
        </div>

        <!-- Center Panel: Property Details -->
        <div class="center-panel" id="centerPanel">
            <div style="text-align: center; padding: 100px 20px; color: #999;">
                <h2>Select an owner to view properties</h2>
            </div>
        </div>

        <!-- Right Panel: Map & Communication Log -->
        <div class="right-panel">
            <div id="map"></div>
            <div class="log-section">
                <div class="log-header">
                    <div>
                        <div class="log-title">Log</div>
                        <div class="log-property-name" id="logPropertyName">Select a property</div>
                    </div>
                    <button class="btn-log-call" onclick="showAddLogModal()">+ Add Log</button>
                </div>
                <div class="log-list" id="logList">
                    <div class="no-logs">No communication history</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Owner Modal -->
    <div id="addOwnerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Owner</h2>
                <button class="modal-close" onclick="closeModal('addOwnerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">Owner Name *</label>
                    <input type="text" id="newOwnerName" class="form-input" style="text-align: left;" placeholder="Enter owner name">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">Owner Email</label>
                    <input type="email" id="newOwnerEmail" class="form-input" style="text-align: left;" placeholder="Enter email">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">Owner Address</label>
                    <input type="text" id="newOwnerAddress" class="form-input" style="text-align: left;" placeholder="Enter address">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">Status</label>
                    <select id="newOwnerStatus" class="form-input">
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeModal('addOwnerModal')">Cancel</button>
                <button class="btn btn-submit" onclick="addNewOwner()">Add Owner</button>
            </div>
        </div>
    </div>

    <!-- Add Property Modal -->
    <div id="addPropertyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Property</h2>
                <button class="modal-close" onclick="closeModal('addPropertyModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">Select Owner *</label>
                    <select id="newPropertyOwner" class="form-input">
                        <option value="">Select an owner...</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">Property Address *</label>
                    <input type="text" id="newPropertyAddress" class="form-input" style="text-align: left;" placeholder="Enter property address">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">Property Name</label>
                    <input type="text" id="newPropertyName" class="form-input" style="text-align: left;" placeholder="Enter property name">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">City</label>
                    <input type="text" id="newPropertyCity" class="form-input" style="text-align: left;" placeholder="Enter city">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">State</label>
                    <input type="text" id="newPropertyState" class="form-input" style="text-align: left;" placeholder="Enter state">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">ZIP</label>
                    <input type="text" id="newPropertyZip" class="form-input" style="text-align: left;" placeholder="Enter ZIP">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeModal('addPropertyModal')">Cancel</button>
                <button class="btn btn-submit" onclick="addNewProperty()">Add Property</button>
            </div>
        </div>
    </div>

    <!-- Add Communication Log Modal -->
    <div id="addLogModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Communication Log</h2>
                <button class="modal-close" onclick="closeModal('addLogModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">Type *</label>
                    <select id="newLogType" class="form-input">
                        <option value="Call">Call</option>
                        <option value="Text">Text</option>
                        <option value="Email">Email</option>
                        <option value="Letter">Letter</option>
                        <option value="Meeting">Meeting</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="text-align: left;">Notes</label>
                    <textarea id="newLogNotes" class="form-input" rows="4" style="resize: vertical; text-align: left;" placeholder="Enter notes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeModal('addLogModal')">Cancel</button>
                <button class="btn btn-submit" onclick="addNewLog()">Add Log</button>
            </div>
        </div>
    </div>

    <!-- Transfer Property Modal -->
    <div id="transferPropertyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Transfer Property</h2>
                <button class="modal-close" onclick="closeModal('transferPropertyModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Transfer this property to a new owner.</p>
                <div class="form-group" style="margin-top: 15px;">
                    <label class="form-label" style="text-align: left;">New Owner</label>
                    <select id="transferOwnerSelect" class="form-input"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeModal('transferPropertyModal')">Cancel</button>
                <button class="btn btn-submit" onclick="transferProperty()">Transfer</button>
            </div>
        </div>
    </div>

    <!-- Status Breakdown Modal -->
    <div id="statusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Owner Status Breakdown</h2>
                <button class="modal-close" onclick="closeModal('statusModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
                <div id="statusStats" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- Call Tracker Modal -->
    <div id="callTrackerModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Call Tracker</h2>
                <button class="modal-close" onclick="closeModal('callTrackerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="chart-container">
                    <canvas id="callChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://xxqesoposwpvljxdfkim.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4cWVzb3Bvc3dwdmxqeGRma2ltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNTU1NDcsImV4cCI6MjA3NDkzMTU0N30.zCJvWNnoKxTlOxJgos8dqfoVYqlXvsfk7_GbjGyt2jo';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global State
        let allOwners = [];
        let allProperties = [];
        let allLogs = [];
        let currentOwner = null;
        let currentProperty = null;
        let currentPropertyIndex = 0;
        let ownerProperties = [];
        let map = null;
        let marker = null;

        const STATUS_OPTIONS = {
            'Never Spoken': '#3498db', // blue
            'IPA': '#34495e',           // black
            'Spoken To': '#2ecc71',     // green
            'Listed': '#e67e22',        // orange
            'WR / ND': '#f1c40f',       // yellow
            'Condo/Religious': '#e91e63', // pink
            'Broker': '#9b59b6',        // purple
            'TCG': '#34495e',           // black
        };

        const STATUS_TAGS = [
            'Buyer', 'Seller', 'Meeting', 'Proposal', '1031', 'Talker',
            '6 Months', 'Market Updates', 'Developer', 'IPA', 'Email',
            'Never Call', 'Rex St', 'Ftn Blue', 'Tabor/Water'
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            initMap();
            await loadAllData();
            setTodayDate();
            populateStatusDropdowns();
            renderFilterTags();
        });

        // Initialize Map
        function initMap() {
            map = L.map('map').setView([45.5231, -122.6765], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        // Set today's date in date picker
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('datePicker').value = today;
        }

        // Load All Data from Supabase
        async function loadAllData() {
            try {
                const { data: owners, error: ownersError } = await supabase.from('owners').select('*');
                if (ownersError) throw ownersError;
                allOwners = owners;

                const { data: properties, error: propertiesError } = await supabase.from('properties').select('*');
                if (propertiesError) throw propertiesError;
                allProperties = properties;

                const { data: logs, error: logsError } = await supabase.from('communication_logs').select('*');
                if (logsError) throw logsError;
                allLogs = logs;

                console.log(`Loaded ${allOwners.length} owners, ${allProperties.length} properties, and ${allLogs.length} logs`);
                renderOwnersList();
                populateOwnerSelect();
                populateFilterLocations();
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading data from Supabase. Please refresh the page.');
            }
        }

        // Render Owners List
        function renderOwnersList(ownersToRender = allOwners) {
            const ownersList = document.getElementById('ownersList');
            const ownerCount = document.getElementById('ownerCount');

            if (ownersToRender.length === 0) {
                ownersList.innerHTML = '<div class="loading">No owners found</div>';
                ownerCount.textContent = '0';
                return;
            }

            ownerCount.textContent = ownersToRender.length;

            ownersList.innerHTML = ownersToRender.map(owner => {
                const propertyCount = allProperties.filter(p => p.owner_id === owner.id).length;
                const statusColor = STATUS_OPTIONS[owner.marker_pin] || '#6c757d';

                return `
                    <div class="owner-item" onclick="selectOwner('${owner.id}')">
                        <div class="owner-status-dot" style="background-color: ${statusColor}"></div>
                        <div class="owner-info">
                            <div class="owner-name">${owner.owner_name || 'Unnamed Owner'}</div>
                            <div class="owner-properties">${propertyCount} ${propertyCount === 1 ? 'Property' : 'Properties'}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Select Owner
        async function selectOwner(ownerId) {
            currentOwner = allOwners.find(o => o.id === ownerId);
            if (!currentOwner) return;

            // Highlight selected owner
            document.querySelectorAll('.owner-item').forEach(item => item.classList.remove('active'));
            const activeItem = Array.from(document.querySelectorAll('.owner-item')).find(item => item.getAttribute('onclick') === `selectOwner('${ownerId}')`);
            if (activeItem) activeItem.classList.add('active');

            // Get owner's properties
            ownerProperties = allProperties.filter(p => p.owner_id === ownerId);
            currentPropertyIndex = 0;

            if (ownerProperties.length > 0) {
                currentProperty = ownerProperties[0];
                await renderPropertyDetails();
                await loadCommunicationLogs();
            } else {
                renderNoProperties();
            }
        }

        function highlightField(value) {
            return value ? 'highlight-green' : 'highlight-yellow';
        }

        // Render Property Details
        async function renderPropertyDetails() {
            if (!currentProperty) return;

            const centerPanel = document.getElementById('centerPanel');

            centerPanel.innerHTML = `
                <div class="property-header">
                    <div class="property-title">
                        ${currentProperty.address || 'No Address'}
                    </div>
                    <div class="property-nav">
                        <button class="nav-btn" onclick="previousProperty()">‚óÄ</button>
                        <span class="property-counter">Property ${currentPropertyIndex + 1} of ${ownerProperties.length}</span>
                        <button class="nav-btn" onclick="nextProperty()">‚ñ∂</button>
                        <button class="btn btn-delete" onclick="deleteProperty()">üóëÔ∏è</button>
                    </div>
                </div>

                <div class="property-images">
                    <div class="image-container">
                        ${currentProperty.image_url_1 ? `<img src="${currentProperty.image_url_1}" alt="Property Image 1">` : 'No Image'}
                        <div class="image-actions">
                            <button onclick="promptAndUpdateProperty('image_url_1', 'Enter Image URL 1')">‚ûï</button>
                            ${currentProperty.image_url_1 ? `<button onclick="updateProperty('image_url_1', null)">‚ùå</button>` : ''}
                        </div>
                    </div>
                    <div class="image-container">
                        ${currentProperty.image_url_2 ? `<img src="${currentProperty.image_url_2}" alt="Property Image 2">` : 'No Image'}
                        <div class="image-actions">
                            <button onclick="promptAndUpdateProperty('image_url_2', 'Enter Image URL 2')">‚ûï</button>
                            ${currentProperty.image_url_2 ? `<button onclick="updateProperty('image_url_2', null)">‚ùå</button>` : ''}
                        </div>
                    </div>
                </div>

                <div class="link-buttons">
                    <div class="link-btn-group">
                        <a href="${currentProperty.costar_link || 'javascript:void(0)'}" target="_blank" class="link-btn ${currentProperty.costar_link ? 'costar' : 'no-link'}">CoStar Link</a>
                        <button class="link-action-btn" onclick="promptAndUpdateProperty('costar_link', 'Enter CoStar Link')">‚ûï</button>
                        <button class="link-action-btn" onclick="updateProperty('costar_link', null)">‚ùå</button>
                    </div>
                    <div class="link-btn-group">
                        <a href="${currentProperty.tps_link || 'javascript:void(0)'}" target="_blank" class="link-btn ${currentProperty.tps_link ? 'costar' : 'no-link'}">TPS Link</a>
                        <button class="link-action-btn" onclick="promptAndUpdateProperty('tps_link', 'Enter TPS Link')">‚ûï</button>
                        <button class="link-action-btn" onclick="updateProperty('tps_link', null)">‚ùå</button>
                    </div>
                    <div class="link-btn-group">
                        <a href="${currentProperty.llc_link || 'javascript:void(0)'}" target="_blank" class="link-btn ${currentProperty.llc_link ? 'costar' : 'no-link'}">LLC Link</a>
                        <button class="link-action-btn" onclick="promptAndUpdateProperty('llc_link', 'Enter LLC Link')">‚ûï</button>
                        <button class="link-action-btn" onclick="updateProperty('llc_link', null)">‚ùå</button>
                    </div>
                </div>

                <div class="section-title" style="margin-top: 30px;">Property Information</div>
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.address)}" value="${currentProperty.address || ''}"
                            onchange="updateProperty('address', this.value)">
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Property Name</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.property_name)}" value="${currentProperty.property_name || ''}"
                            onchange="updateProperty('property_name', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">City</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.city)}" value="${currentProperty.city || ''}"
                            onchange="updateProperty('city', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">State</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.state)}" value="${currentProperty.state || ''}"
                            onchange="updateProperty('state', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ZIP</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.zip)}" value="${currentProperty.zip || ''}"
                            onchange="updateProperty('zip', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Year Built</label>
                        <input type="number" class="form-input ${highlightField(currentProperty.built)}" value="${currentProperty.built || ''}"
                            onchange="updateProperty('built', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Submarket</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.submarket)}" value="${currentProperty.submarket || ''}"
                            onchange="updateProperty('submarket', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <select class="form-input ${highlightField(currentProperty.location)}" onchange="updateProperty('location', this.value)">
                            <option value="">Select...</option>
                            <option value="SE Portland" ${currentProperty.location === 'SE Portland' ? 'selected' : ''}>SE Portland</option>
                            <option value="NE Portland" ${currentProperty.location === 'NE Portland' ? 'selected' : ''}>NE Portland</option>
                            <option value="NW Portland" ${currentProperty.location === 'NW Portland' ? 'selected' : ''}>NW Portland</option>
                            <option value="SW Portland" ${currentProperty.location === 'SW Portland' ? 'selected' : ''}>SW Portland</option>
                            <option value="N Portland" ${currentProperty.location === 'N Portland' ? 'selected' : ''}>N Portland</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Parcel #</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.parcel_number)}" value="${currentProperty.parcel_number || ''}"
                            onchange="updateProperty('parcel_number', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Property ID</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.property_id)}" value="${currentProperty.property_id || ''}"
                            onchange="updateProperty('property_id', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">CoStar #</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.costar_number)}" value="${currentProperty.costar_number || ''}"
                            onchange="updateProperty('costar_number', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Units</label>
                        <input type="number" class="form-input ${highlightField(currentProperty.units)}" value="${currentProperty.units || ''}"
                            onchange="updateProperty('units', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Longitude</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.long)}" value="${currentProperty.long || ''}"
                            onchange="updateProperty('long', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Latitude</label>
                        <input type="text" class="form-input ${highlightField(currentProperty.latt)}" value="${currentProperty.latt || ''}"
                            onchange="updateProperty('latt', this.value)">
                    </div>
                </div>

                <div class="section-title" style="margin-top: 30px;">Owner Information</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Owner Status</label>
                        <select class="form-input" onchange="updateOwner('marker_pin', this.value)">
                            ${Object.keys(STATUS_OPTIONS).map(status => `
                                <option value="${status}" ${currentOwner.marker_pin === status ? 'selected' : ''}>${status}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Spoken</label>
                        <input type="date" class="form-input" value="${currentOwner.last_spoken || ''}"
                            onchange="updateOwner('last_spoken', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Next Follow-Up</label>
                        <input type="date" class="form-input ${highlightField(currentOwner.next_follow_up)}" value="${currentOwner.next_follow_up || ''}"
                            onchange="updateOwner('next_follow_up', this.value)">
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Owner Address</label>
                        <input type="text" class="form-input ${highlightField(currentOwner.owner_address)}" value="${currentOwner.owner_address || ''}"
                            onchange="updateOwner('owner_address', this.value)">
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Owner Email</label>
                        <input type="email" class="form-input ${highlightField(currentOwner.owner_email)}" value="${currentOwner.owner_email || ''}"
                            onchange="updateOwner('owner_email', this.value)">
                    </div>
                </div>

                <div class="section-title" style="margin-top: 30px;">Phone Numbers</div>
                <table class="phone-table">
                    <thead>
                        <tr>
                            <th>Label</th>
                            <th>Number</th>
                            <th style="width: 60px; text-align: center;">Call</th>
                            <th style="width: 60px; text-align: center;">Spoken</th>
                            <th style="width: 60px; text-align: center;">Delete</th>
                        </tr>
                    </thead>
                    <tbody id="phoneTableBody">
                        ${renderPhoneRows()}
                    </tbody>
                </table>
                <button class="btn add-phone-btn" onclick="addPhoneRow()">+ Add Phone</button>
                <div class="cell-only-row">
                    <label><input type="checkbox" ${currentOwner.call_with_cell_only ? 'checked' : ''}
                        onchange="updateOwner('call_with_cell_only', this.checked)"> Call with cell only</label>
                </div>

                <div class="section-title" style="margin-top: 30px;">Status Tags</div>
                <div id="ownerStatusTags" class="status-tags-container"></div>

                <div class="section-title" style="margin-top: 30px;">Danger Zone</div>
                <button class="btn btn-delete" onclick="showTransferPropertyModal()">Transfer Property</button>
                <button class="btn btn-delete" onclick="deleteOwner()">Delete Owner</button>
            `;

            renderOwnerTags();
            // Update map
            if (currentProperty.latt && currentProperty.long) {
                const lat = parseFloat(currentProperty.latt);
                const lng = parseFloat(currentProperty.long);
                if (!isNaN(lat) && !isNaN(lng)) {
                    map.setView([lat, lng], 15);
                    if (marker) {
                        marker.setLatLng([lat, lng]);
                    } else {
                        marker = L.marker([lat, lng]).addTo(map);
                    }
                }
            }

            // Update log property name
            document.getElementById('logPropertyName').textContent = currentProperty.address || 'No address';
        }

        // Render phone rows
        function renderPhoneRows() {
            let html = '';
            for (let i = 1; i <= 5; i++) {
                const label = currentOwner[`phone_label_${i}`] || '';
                const number = currentOwner[`phone_number_${i}`] || '';
                const spoken = currentOwner[`spoken_${i}`] || false;

                if (i === 1 || currentOwner[`phone_number_${i-1}`]) {
                     html += `
                        <tr>
                            <td>
                                <input type="text" class="form-input ${highlightField(label)}" placeholder="Label (e.g., Mobile)" value="${label}"
                                    onchange="updateOwner('phone_label_${i}', this.value)">
                            </td>
                            <td>
                                <input type="text" class="form-input ${highlightField(number)}" placeholder="Number" value="${number}"
                                    onchange="updateOwner('phone_number_${i}', this.value)">
                            </td>
                            <td style="text-align: center;">
                                <button class="phone-action-btn" onclick="callPhone('${number}')">üìû</button>
                            </td>
                            <td style="text-align: center;">
                                <input type="checkbox" ${spoken ? 'checked' : ''}
                                    onchange="updateOwner('spoken_${i}', this.checked)">
                            </td>
                            <td style="text-align: center;">
                                <button class="phone-action-btn" onclick="deletePhone(${i})">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                }
            }
            return html;
        }

        // Render no properties message
        function renderNoProperties() {
            const centerPanel = document.getElementById('centerPanel');
            centerPanel.innerHTML = `
                <div style="text-align: center; padding: 100px 20px; color: #999;">
                    <h2>No properties for this owner</h2>
                    <p style="margin-top: 10px;">Click "Add Property" to add a property for ${currentOwner.owner_name}</p>
                </div>
            `;
        }

        // Navigation functions
        function previousProperty() {
            if (currentPropertyIndex > 0) {
                currentPropertyIndex--;
                currentProperty = ownerProperties[currentPropertyIndex];
                renderPropertyDetails();
                loadCommunicationLogs();
            }
        }

        function nextProperty() {
            if (currentPropertyIndex < ownerProperties.length - 1) {
                currentPropertyIndex++;
                currentProperty = ownerProperties[currentPropertyIndex];
                renderPropertyDetails();
                loadCommunicationLogs();
            }
        }

        // Update Property
        async function updateProperty(field, value) {
            try {
                const { error } = await supabase
                    .from('properties')
                    .update({ [field]: value })
                    .eq('id', currentProperty.id);

                if (error) throw error;

                currentProperty[field] = value;

                const index = allProperties.findIndex(p => p.id === currentProperty.id);
                if (index !== -1) allProperties[index][field] = value;

                await renderPropertyDetails();
            } catch (error) {
                console.error('Error updating property:', error);
                alert('Error updating property. Please try again.');
            }
        }

        // Update Owner
        async function updateOwner(field, value) {
            try {
                const { error } = await supabase
                    .from('owners')
                    .update({ [field]: value })
                    .eq('id', currentOwner.id);

                if (error) throw error;

                currentOwner[field] = value;

                const index = allOwners.findIndex(o => o.id === currentOwner.id);
                if (index !== -1) allOwners[index][field] = value;

                if (field === 'marker_pin' || field === 'status_tags') {
                    renderOwnersList();
                }
                await renderPropertyDetails();
            } catch (error) {
                console.error('Error updating owner:', error);
                alert('Error updating owner. Please try again.');
            }
        }

        // Call Phone
        function callPhone(number) {
            if (number) {
                window.open(`tel:${number}`);
            }
        }

        // Load Communication Logs
        async function loadCommunicationLogs() {
            if (!currentOwner) return;
            const logList = document.getElementById('logList');
            const ownerLogs = allLogs.filter(log => log.owner_id === currentOwner.id).sort((a,b) => new Date(b.date) - new Date(a.date));

            if (ownerLogs.length === 0) {
                logList.innerHTML = '<div class="no-logs">No communication history</div>';
                return;
            }

            logList.innerHTML = ownerLogs.map(log => `
                <div class="log-item">
                    <div class="log-date">${formatDate(log.date)}</div>
                    <div class="log-type">${log.type || 'Note'}</div>
                    <div class="log-notes">${log.notes || 'No notes'}</div>
                </div>
            `).join('');
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'No date';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // Delete Property
        async function deleteProperty() {
            if (!currentProperty) return;

            if (!confirm('Are you sure you want to delete this property?')) return;

            try {
                const { error } = await supabase
                    .from('properties')
                    .delete()
                    .eq('id', currentProperty.id);

                if (error) throw error;

                allProperties = allProperties.filter(p => p.id !== currentProperty.id);
                ownerProperties = ownerProperties.filter(p => p.id !== currentProperty.id);

                if (ownerProperties.length > 0) {
                    currentPropertyIndex = Math.max(0, currentPropertyIndex - 1);
                    currentProperty = ownerProperties[currentPropertyIndex];
                    await renderPropertyDetails();
                    await loadCommunicationLogs();
                } else {
                    renderNoProperties();
                }

                alert('Property deleted successfully');
            } catch (error) {
                console.error('Error deleting property:', error);
                alert('Error deleting property. Please try again.');
            }
        }

        async function deletePhone(index) {
            if (!confirm('Are you sure you want to delete this phone number?')) return;
            const updates = {};
            updates[`phone_label_${index}`] = null;
            updates[`phone_number_${index}`] = null;
            updates[`spoken_${index}`] = null;

            try {
                const { error } = await supabase
                    .from('owners')
                    .update(updates)
                    .eq('id', currentOwner.id);

                if (error) throw error;

                Object.assign(currentOwner, updates);
                await renderPropertyDetails();

            } catch (error) {
                console.error('Error deleting phone:', error);
                alert('Error deleting phone. Please try again.');
            }
        }

        function promptAndUpdateProperty(field, message) {
            const newValue = prompt(message);
            if (newValue !== null) {
                updateProperty(field, newValue.trim());
            }
        }

        // Modal Functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showAddOwnerModal() {
            document.getElementById('addOwnerModal').classList.add('active');
        }

        function showAddPropertyModal() {
            if (!currentOwner) {
                alert('Please select an owner first.');
                return;
            }
            document.getElementById('addPropertyModal').classList.add('active');
        }

        function showAddLogModal() {
            if (!currentOwner) {
                return;
            }
            document.getElementById('addLogModal').classList.add('active');
        }

        // Add New Owner
        async function addNewOwner() {
            const name = document.getElementById('newOwnerName').value.trim();
            if (!name) {
                alert('Please enter an owner name');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('owners')
                    .insert([{
                        owner_name: name,
                        owner_email: document.getElementById('newOwnerEmail').value.trim(),
                        owner_address: document.getElementById('newOwnerAddress').value.trim(),
                        marker_pin: document.getElementById('newOwnerStatus').value
                    }])
                    .select();

                if (error) throw error;

                allOwners.push(data[0]);
                renderOwnersList();
                populateOwnerSelect();

                closeModal('addOwnerModal');

                // Clear form
                document.getElementById('newOwnerName').value = '';
                document.getElementById('newOwnerEmail').value = '';
                document.getElementById('newOwnerAddress').value = '';

                alert('Owner added successfully');
            } catch (error) {
                console.error('Error adding owner:', error);
                alert('Error adding owner. Please try again.');
            }
        }

        // Add New Property
        async function addNewProperty() {
            const ownerId = document.getElementById('newPropertyOwner').value;
            const address = document.getElementById('newPropertyAddress').value.trim();

            if (!ownerId) {
                alert('Please select an owner');
                return;
            }
            if (!address) {
                alert('Please enter a property address');
                return;
            }

            try {
                const owner = allOwners.find(o => o.id === ownerId);

                const { data, error } = await supabase
                    .from('properties')
                    .insert([{
                        owner_id: ownerId,
                        owner_name: owner?.owner_name,
                        address: address,
                        property_name: document.getElementById('newPropertyName').value.trim(),
                        city: document.getElementById('newPropertyCity').value.trim(),
                        state: document.getElementById('newPropertyState').value.trim(),
                        zip: document.getElementById('newPropertyZip').value.trim()
                    }])
                    .select();

                if (error) throw error;

                allProperties.push(data[0]);

                closeModal('addPropertyModal');

                // Clear form
                document.getElementById('newPropertyOwner').value = '';
                document.getElementById('newPropertyAddress').value = '';
                document.getElementById('newPropertyName').value = '';
                document.getElementById('newPropertyCity').value = '';
                document.getElementById('newPropertyState').value = '';
                document.getElementById('newPropertyZip').value = '';

                alert('Property added successfully');
            } catch (error) {
                console.error('Error adding property:', error);
                alert('Error adding property. Please try again.');
            }
        }

        // Add New Log
        async function addNewLog() {
            const date = document.getElementById('datePicker').value;
            const type = document.getElementById('newLogType').value;
            const notes = document.getElementById('newLogNotes').value.trim();

            if (!date || !type) {
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('communication_logs')
                    .insert([{
                        owner_id: currentOwner.id,
                        owner_name: currentOwner.owner_name,
                        date: date,
                        type: type,
                        notes: notes
                    }])
                    .select();

                if (error) throw error;

                allLogs.push(data[0]);

                if (type === 'Call') {
                    await updateOwner('last_spoken', date);
                }

                await loadCommunicationLogs();

                closeModal('addLogModal');

                document.getElementById('newLogNotes').value = '';

            } catch (error) {
                console.error('Error adding log:', error);
            }
        }

        function populateStatusDropdowns() {
            const statusDropdowns = [document.getElementById('newOwnerStatus'), document.getElementById('filterStatus')];
            statusDropdowns.forEach(dropdown => {
                if(dropdown.id === 'filterStatus') dropdown.innerHTML = '<option value="">All Statuses</option>';
                else dropdown.innerHTML = '';
                for (const status in STATUS_OPTIONS) {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    dropdown.appendChild(option);
                }
            });
        }

        // Populate owner select in add property modal
        function populateOwnerSelect() {
            const select = document.getElementById('newPropertyOwner');
            select.innerHTML = '<option value="">Select an owner...</option>' +
                allOwners.map(owner => `<option value="${owner.id}">${owner.owner_name}</option>`).join('');
        }

        // Populate filter locations
        function populateFilterLocations() {
            const locations = [...new Set(allProperties.map(p => p.location).filter(l => l))];
            const select = document.getElementById('filterLocation');
            select.innerHTML = '<option value="">All Locations</option>' +
                locations.map(loc => `<option value="${loc}">${loc}</option>`).join('');
        }

        // Search and Filter
        function applyFiltersAndSearch() {
            let filtered = [...allOwners];
            const query = document.getElementById('searchInput').value.toLowerCase().trim();

            // Filter logic
            const location = document.getElementById('filterLocation').value;
            const city = document.getElementById('filterCity').value.toLowerCase();
            const submarket = document.getElementById('filterSubmarket').value.toLowerCase();
            const zip = document.getElementById('filterZip').value;
            const yearMin = document.getElementById('filterYearMin').value;
            const yearMax = document.getElementById('filterYearMax').value;
            const unitsMin = document.getElementById('filterUnitsMin').value;
            const unitsMax = document.getElementById('filterUnitsMax').value;
            const status = document.getElementById('filterStatus').value;

            const activeTags = Array.from(document.querySelectorAll('#filterStatusTags .active')).map(tag => tag.dataset.tag);

            const propertyFilters = [location, city, submarket, zip, yearMin, yearMax, unitsMin, unitsMax].some(f => f);

            if (status) {
                filtered = filtered.filter(owner => owner.marker_pin === status);
            }

            if (activeTags.length > 0) {
                filtered = filtered.filter(owner => activeTags.every(tag => (owner.status_tags || []).includes(tag)));
            }

            if (propertyFilters) {
                const matchingOwnerIds = new Set(allProperties.filter(p => {
                    if (location && p.location !== location) return false;
                    if (city && !(p.city || '').toLowerCase().includes(city)) return false;
                    if (submarket && !(p.submarket || '').toLowerCase().includes(submarket)) return false;
                    if (zip && p.zip != zip) return false;
                    if (yearMin && p.built < yearMin) return false;
                    if (yearMax && p.built > yearMax) return false;
                    if (unitsMin && p.units < unitsMin) return false;
                    if (unitsMax && p.units > unitsMax) return false;
                    return true;
                }).map(p => p.owner_id));

                filtered = filtered.filter(owner => matchingOwnerIds.has(owner.id));
            }

            // Search logic
            if (query) {
                const propertyOwnerIds = new Set(allProperties.filter(p => (p.address || '').toLowerCase().includes(query)).map(p => p.owner_id));
                filtered = filtered.filter(owner => {
                    const nameMatch = (owner.owner_name || '').toLowerCase().includes(query);
                    return nameMatch || propertyOwnerIds.has(owner.id);
                });
            }

            renderOwnersList(filtered);
        }

        function performSearch() {
            applyFiltersAndSearch();
        }

        // Toggle Filters
        function toggleFilters() {
            const panel = document.getElementById('filterPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // Apply Filters
        function applyFilters() {
            applyFiltersAndSearch();
        }

        // Clear Filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterLocation').value = '';
            document.getElementById('filterCity').value = '';
            document.getElementById('filterSubmarket').value = '';
            document.getElementById('filterZip').value = '';
            document.getElementById('filterYearMin').value = '';
            document.getElementById('filterYearMax').value = '';
            document.getElementById('filterUnitsMin').value = '';
            document.getElementById('filterUnitsMax').value = '';
            document.getElementById('filterStatus').value = '';
            document.querySelectorAll('#filterStatusTags .active').forEach(tag => tag.classList.remove('active'));
            applyFiltersAndSearch();
        }

        // Show Status Breakdown
        function showStatusBreakdown() {
            const statusCounts = {};
            allOwners.forEach(owner => {
                const status = owner.marker_pin || 'Unspecified';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            document.getElementById('statusModal').classList.add('active');

            const ctx = document.getElementById('statusChart').getContext('2d');

            if(window.statusChartInstance) {
                window.statusChartInstance.destroy();
            }

            window.statusChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: Object.keys(statusCounts).map(status => STATUS_OPTIONS[status] || '#6c757d')
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            const stats = Object.entries(statusCounts)
                .map(([status, count]) => {
                    const percentage = ((count / allOwners.length) * 100).toFixed(1);
                    return `<div style="padding: 10px; background: #f8f9fa; margin-bottom: 5px; border-radius: 4px;">
                        <strong>${status}:</strong> ${count} owners (${percentage}%)
                    </div>`;
                }).join('');

            document.getElementById('statusStats').innerHTML = stats;
        }

        // Call Tracker
        async function showCallTracker() {
            document.getElementById('callTrackerModal').classList.add('active');

            const callLogs = allLogs.filter(log => log.type === 'Call');
            const callsByDay = callLogs.reduce((acc, log) => {
                const date = log.date.split('T')[0];
                acc[date] = (acc[date] || 0) + 1;
                return acc;
            }, {});

            const labels = [...Array(30)].map((_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - i);
                return d.toISOString().split('T')[0];
            }).reverse();

            const data = labels.map(label => callsByDay[label] || 0);

            const ctx = document.getElementById('callChart').getContext('2d');
            if (window.callChartInstance) {
                window.callChartInstance.destroy();
            }
            window.callChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Calls per Day (Last 30 Days)',
                        data: data,
                        backgroundColor: 'rgba(43, 90, 168, 0.7)',
                    }]
                },
                options: {
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            }
                        },
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Status Tags
        function renderFilterTags() {
            const container = document.getElementById('filterStatusTags');
            container.innerHTML = STATUS_TAGS.map(tag =>
                `<button class="status-tag" data-tag="${tag}" onclick="toggleFilterTag(this)">${tag}</button>`
            ).join('');
        }

        function toggleFilterTag(element) {
            element.classList.toggle('active');
            applyFiltersAndSearch();
        }

        function renderOwnerTags() {
            const container = document.getElementById('ownerStatusTags');
            if (!container) return;
            container.innerHTML = STATUS_TAGS.map(tag => {
                const isActive = (currentOwner.status_tags || []).includes(tag);
                return `<button class="status-tag ${isActive ? 'active' : ''}" onclick="toggleOwnerTag('${tag}')">${tag}</button>`
            }).join('');
        }

        async function toggleOwnerTag(tag) {
            const currentTags = currentOwner.status_tags || [];
            const tagIndex = currentTags.indexOf(tag);
            if (tagIndex > -1) {
                currentTags.splice(tagIndex, 1);
            } else {
                currentTags.push(tag);
            }
            await updateOwner('status_tags', currentTags);
        }

        // Owner/Property Management
        async function deleteOwner() {
            if (!currentOwner) return;
            if (!confirm(`Are you sure you want to delete ${currentOwner.owner_name}? This will also delete all associated properties and logs.`)) return;

            try {
                // This should ideally be a transaction in a real-world scenario
                await supabase.from('communication_logs').delete().eq('owner_id', currentOwner.id);
                await supabase.from('properties').delete().eq('owner_id', currentOwner.id);
                await supabase.from('owners').delete().eq('id', currentOwner.id);

                alert('Owner deleted successfully.');
                window.location.reload(); // Simple way to refresh state
            } catch (error) {
                console.error('Error deleting owner:', error);
                alert('Failed to delete owner.');
            }
        }

        function showTransferPropertyModal() {
            if (!currentProperty) return;
            const select = document.getElementById('transferOwnerSelect');
            select.innerHTML = allOwners
                .filter(o => o.id !== currentOwner.id)
                .map(o => `<option value="${o.id}">${o.owner_name}</option>`)
                .join('');
            document.getElementById('transferPropertyModal').classList.add('active');
        }

        async function transferProperty() {
            const newOwnerId = document.getElementById('transferOwnerSelect').value;
            if (!newOwnerId) {
                alert('Please select a new owner.');
                return;
            }

            await updateProperty('owner_id', newOwnerId);
            alert('Property transferred successfully.');
            closeModal('transferPropertyModal');
            selectOwner(newOwnerId); // Switch to the new owner's view
        }

        function addPhoneRow() {
            // This is a bit of a hack. A better implementation would dynamically add rows.
            // For now, we'll just re-render, and the logic in `renderPhoneRows` will show the next empty row.
            renderPropertyDetails();
        }
    </script>
</body>
</html>